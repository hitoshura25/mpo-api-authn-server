# Centralized Change Detection - Callable Workflow
# 
# Extracted from build-and-test.yml to eliminate duplication and provide
# consistent change detection across all workflows using proven dorny/paths-filter patterns.
#
# USAGE:
#   Uses dorny/paths-filter@v3 for reliable, maintained change detection
#   Supports both PR context (against base branch) and push context (against previous commit)
#
# COMPONENT BOUNDARIES:
#   - webauthn-server: webauthn-server/, webauthn-test-lib/ (shared dependency)
#   - test-credentials-service: webauthn-test-credentials-service/, webauthn-test-lib/ (shared dependency) 
#   - openapi-specification: OpenAPI files that trigger client regeneration
#   - e2e-tests: E2E test files and configurations
#   - workflows: GitHub Actions workflow files

name: Detect Changes - Centralized

on:
  workflow_call:
    outputs:
      # Component change indicators for conditional execution
      webauthn-server-changed:
        description: 'Whether webauthn-server or shared dependencies changed'
        value: ${{ jobs.detect-changes.outputs.webauthn-server-changed }}
      test-credentials-service-changed:
        description: 'Whether test-credentials-service or shared dependencies changed' 
        value: ${{ jobs.detect-changes.outputs.test-credentials-service-changed }}
      e2e-tests-changed:
        description: 'Whether E2E test files changed'
        value: ${{ jobs.detect-changes.outputs.e2e-tests-changed }}
      workflows-changed:
        description: 'Whether workflow files changed'
        value: ${{ jobs.detect-changes.outputs.workflows-changed }}
      docker-affecting-workflows-changed:
        description: 'Whether Docker-affecting workflow files changed'
        value: ${{ jobs.detect-changes.outputs.docker-affecting-workflows-changed }}
      docker-security-workflows-changed:
        description: 'Whether Docker security workflow files changed'
        value: ${{ jobs.detect-changes.outputs.docker-security-workflows-changed }}
      e2e-test-affecting-workflows-changed:
        description: 'Whether E2E test workflow files changed'
        value: ${{ jobs.detect-changes.outputs.e2e-test-affecting-workflows-changed }}
      client-publishing-affecting-workflows-changed:
        description: 'Whether client publishing workflow files changed'
        value: ${{ jobs.detect-changes.outputs.client-publishing-affecting-workflows-changed }}
      unit-test-affecting-workflows-changed:
        description: 'Whether unit test workflow files changed'
        value: ${{ jobs.detect-changes.outputs.unit-test-affecting-workflows-changed }}
      security-affecting-workflows-changed:
        description: 'Whether security workflow files changed'
        value: ${{ jobs.detect-changes.outputs.security-affecting-workflows-changed }}
      
      # Granular E2E test change detection for platform-specific triggering
      web-e2e-test-files-changed:
        description: 'Whether web E2E test files changed'
        value: ${{ jobs.detect-changes.outputs.web-e2e-test-files-changed }}
      android-e2e-test-files-changed:
        description: 'Whether Android E2E test files changed'
        value: ${{ jobs.detect-changes.outputs.android-e2e-test-files-changed }}
      
      # Build decision outputs (compatible with build-and-test.yml)
      should-run-docker-workflow:
        description: 'Whether Docker workflow should be executed'
        value: ${{ jobs.detect-changes.outputs.should-run-docker-workflow }}
      should-run-e2e-workflow:
        description: 'Whether E2E workflow should be executed'
        value: ${{ jobs.detect-changes.outputs.should-run-e2e-workflow }}
      should-run-tests-workflow:
        description: 'Whether unit tests workflow should be executed'
        value: ${{ jobs.detect-changes.outputs.should-run-tests-workflow }}
      should-run-client-publishing-workflow:
        description: 'Whether client publishing workflow should be executed'
        value: ${{ jobs.detect-changes.outputs.should-run-client-publishing-workflow }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # Component change indicators
      webauthn-server-changed: ${{ steps.decision-matrix.outputs.webauthn-server-changed }}
      test-credentials-service-changed: ${{ steps.decision-matrix.outputs.test-credentials-service-changed }}
      e2e-tests-changed: ${{ steps.decision-matrix.outputs.e2e-tests-changed }}
      workflows-changed: ${{ steps.decision-matrix.outputs.workflows-changed }}
      docker-affecting-workflows-changed: ${{ steps.decision-matrix.outputs.docker-affecting-workflows-changed }}
      docker-security-workflows-changed: ${{ steps.decision-matrix.outputs.docker-security-workflows-changed }}
      e2e-test-affecting-workflows-changed: ${{ steps.decision-matrix.outputs.e2e-test-affecting-workflows-changed }}
      client-publishing-affecting-workflows-changed: ${{ steps.decision-matrix.outputs.client-publishing-affecting-workflows-changed }}
      unit-test-affecting-workflows-changed: ${{ steps.decision-matrix.outputs.unit-test-affecting-workflows-changed }}
      security-affecting-workflows-changed: ${{ steps.decision-matrix.outputs.security-affecting-workflows-changed }}
      
      # Granular E2E test change detection outputs
      web-e2e-test-files-changed: ${{ steps.decision-matrix.outputs.web-e2e-test-files-changed }}
      android-e2e-test-files-changed: ${{ steps.decision-matrix.outputs.android-e2e-test-files-changed }}
      
      # Build decision outputs (backward compatibility)
      should-run-docker-workflow: ${{ steps.decision-matrix.outputs.should-run-docker-workflow }}
      should-run-e2e-workflow: ${{ steps.decision-matrix.outputs.should-run-e2e-workflow }}
      should-run-tests-workflow: ${{ steps.decision-matrix.outputs.should-run-tests-workflow }}
      should-run-client-publishing-workflow: ${{ steps.decision-matrix.outputs.should-run-client-publishing-workflow }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Proven change detection using dorny/paths-filter (extracted from build-and-test.yml)
      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docs-changed:
              - '**.md'
              - 'docs/**'
              - '!.github/workflows/**'
            
            # Workflow change detection  
            orchestration-workflows:
              - '.github/workflows/main-ci-cd.yml'
              - '.github/workflows/build-and-test.yml'
              - '.github/workflows/detect-changes.yml'
            unit-test-workflows:
              - '.github/workflows/unit-tests.yml'
            docker-workflows:
              - '.github/workflows/docker-build.yml'
            e2e-workflows:
              - '.github/workflows/e2e-tests.yml'
              - '.github/workflows/web-e2e-tests.yml'
              - '.github/workflows/android-e2e-tests.yml'
            publishing-workflows:
              - '.github/workflows/client-publish.yml'
              - '.github/workflows/publish-*.yml'
            
            # Docker-affecting workflow changes (optimization: only these trigger Docker builds)
            docker-affecting-workflows:
              - '.github/workflows/docker-build.yml'        # Direct Docker build logic
              - '.github/workflows/build-and-test.yml'      # Docker build coordination
              - '.github/workflows/main-ci-cd.yml'          # Docker build decisions
              - '.github/workflows/detect-changes.yml'      # Change detection affects build decisions
            
            # E2E test workflow changes (affect E2E execution but not Docker builds)
            e2e-test-affecting-workflows:
              - '.github/workflows/e2e-tests.yml'
              - '.github/workflows/web-e2e-tests.yml'
              - '.github/workflows/android-e2e-tests.yml'
            
            # Client publishing workflow changes (affect publishing but not Docker builds)
            client-publishing-affecting-workflows:
              - '.github/workflows/client-publish.yml'
              - '.github/workflows/publish-*.yml'
            
            # Unit test workflow changes (affect unit testing but not Docker builds)
            unit-test-affecting-workflows:
              - '.github/workflows/unit-tests.yml'
            
            # Security workflow changes (affect security scanning but not Docker builds)
            security-affecting-workflows:
              - '.github/workflows/security-analysis.yml'
              - '.github/workflows/vulnerability-monitor.yml'
            
            # Docker security workflow changes (CRITICAL: affect Docker security scanning functionality)
            docker-security-workflows:
              - '.github/workflows/docker-security-scan.yml'
              - 'scripts/docker/scan-security.sh'
            
            # Component-specific changes (webauthn-server + shared dependencies)
            webauthn-server-tests:
              - 'webauthn-server/src/**'
              - 'webauthn-server/build.gradle.kts'
              - 'webauthn-test-lib/**'
              - 'settings.gradle.kts'
              - 'build.gradle.kts'
              - 'gradle.properties'
              - 'gradle/**'
            webauthn-server-docker:
              - 'webauthn-server/src/main/**'
              - 'webauthn-server/Dockerfile'
              - 'webauthn-server/build.gradle.kts'
              - 'webauthn-test-lib/src/main/**'
              - 'settings.gradle.kts'
              - 'build.gradle.kts'
              - 'gradle.properties'
            
            # Component-specific changes (test-credentials-service + shared dependencies)
            test-credentials-tests:
              - 'webauthn-test-credentials-service/src/**'
              - 'webauthn-test-credentials-service/build.gradle.kts'
              - 'webauthn-test-lib/**'
              - 'settings.gradle.kts'
              - 'build.gradle.kts'
              - 'gradle.properties'
              - 'gradle/**'
            test-credentials-docker:
              - 'webauthn-test-credentials-service/src/main/**'
              - 'webauthn-test-credentials-service/Dockerfile'
              - 'webauthn-test-credentials-service/build.gradle.kts'
              - 'webauthn-test-lib/src/main/**'
              - 'settings.gradle.kts'
              - 'build.gradle.kts'
              - 'gradle.properties'
            
            # OpenAPI specification changes (triggers client generation)
            openapi-changes:
              - 'webauthn-server/src/main/resources/openapi/documentation.yaml'
              - 'android-client-library/**'
              - 'typescript-client-library/**'
              - 'config/publishing-config.yml'
            
            # E2E test changes (granular patterns for platform-specific detection)
            e2e-test-changes:
              - 'web-test-client/**'
              - 'android-test-client/**'
              - '.github/workflows/e2e-tests.yml'
              - '.github/workflows/web-e2e-tests.yml'
              - '.github/workflows/android-e2e-tests.yml'
            
            # Granular E2E patterns for platform-specific triggering
            web-e2e-test-files:
              - 'web-test-client/tests/**'
              - 'web-test-client/**/*.spec.ts'
              - 'web-test-client/**/*.test.ts'
              - 'web-test-client/src/**'
              - 'web-test-client/package.json'
              - 'web-test-client/tsconfig.json'
              - 'web-test-client/webpack.config.js'
              - '.github/workflows/web-e2e-tests.yml'
            
            android-e2e-test-files:
              - 'android-test-client/**/*.kt'
              - 'android-test-client/app/src/**'
              - 'android-test-client/app/build.gradle.kts'
              - 'android-test-client/settings.gradle.kts'
              - '.github/workflows/android-e2e-tests.yml'

      - name: Print change detection results
        run: |
          echo "🔍 Change Detection Results:"
          echo "webauthn-server-tests: ${{ steps.changes.outputs.webauthn-server-tests }}"
          echo "webauthn-server-docker: ${{ steps.changes.outputs.webauthn-server-docker }}"
          echo "test-credentials-tests: ${{ steps.changes.outputs.test-credentials-tests }}"
          echo "test-credentials-docker: ${{ steps.changes.outputs.test-credentials-docker }}"
          echo "openapi-changes: ${{ steps.changes.outputs.openapi-changes }}"
          echo "e2e-test-changes: ${{ steps.changes.outputs.e2e-test-changes }}"
          echo "web-e2e-test-files: ${{ steps.changes.outputs.web-e2e-test-files }}"
          echo "android-e2e-test-files: ${{ steps.changes.outputs.android-e2e-test-files }}"
          echo "orchestration-workflows: ${{ steps.changes.outputs.orchestration-workflows }}"
          echo "docker-affecting-workflows: ${{ steps.changes.outputs.docker-affecting-workflows }}"
          echo "docker-security-workflows: ${{ steps.changes.outputs.docker-security-workflows }}"
          echo "e2e-test-affecting-workflows: ${{ steps.changes.outputs.e2e-test-affecting-workflows }}"
          echo "client-publishing-affecting-workflows: ${{ steps.changes.outputs.client-publishing-affecting-workflows }}"
          echo "unit-test-affecting-workflows: ${{ steps.changes.outputs.unit-test-affecting-workflows }}"
          echo "security-affecting-workflows: ${{ steps.changes.outputs.security-affecting-workflows }}"

      - name: Apply decision matrix logic
        id: decision-matrix
        run: |
          # Component-level change detection (combining tests + docker patterns)
          WEBAUTHN_SERVER_CHANGED="false"
          if [[ "${{ steps.changes.outputs.webauthn-server-tests }}" == "true" || "${{ steps.changes.outputs.webauthn-server-docker }}" == "true" ]]; then
            WEBAUTHN_SERVER_CHANGED="true"
          fi
          
          TEST_CREDS_SERVICE_CHANGED="false"  
          if [[ "${{ steps.changes.outputs.test-credentials-tests }}" == "true" || "${{ steps.changes.outputs.test-credentials-docker }}" == "true" ]]; then
            TEST_CREDS_SERVICE_CHANGED="true"
          fi
          
          OPENAPI_CHANGED="${{ steps.changes.outputs.openapi-changes }}"
          E2E_TESTS_CHANGED="${{ steps.changes.outputs.e2e-test-changes }}"
          
          # Granular E2E pattern detection
          WEB_E2E_FILES_CHANGED="${{ steps.changes.outputs.web-e2e-test-files }}"
          ANDROID_E2E_FILES_CHANGED="${{ steps.changes.outputs.android-e2e-test-files }}"
          
          # Enhanced workflow change detection (preserves backward compatibility)
          WORKFLOWS_CHANGED="false"
          if [[ "${{ steps.changes.outputs.orchestration-workflows }}" == "true" || "${{ steps.changes.outputs.unit-test-workflows }}" == "true" || "${{ steps.changes.outputs.docker-workflows }}" == "true" || "${{ steps.changes.outputs.e2e-workflows }}" == "true" || "${{ steps.changes.outputs.publishing-workflows }}" == "true" ]]; then
            WORKFLOWS_CHANGED="true" 
          fi
          
          # Specific workflow category detection (optimization: granular build triggering)
          DOCKER_AFFECTING_WORKFLOWS_CHANGED="${{ steps.changes.outputs.docker-affecting-workflows }}"
          DOCKER_SECURITY_WORKFLOWS_CHANGED="${{ steps.changes.outputs.docker-security-workflows }}"
          E2E_TEST_AFFECTING_WORKFLOWS_CHANGED="${{ steps.changes.outputs.e2e-test-affecting-workflows }}"
          CLIENT_PUBLISHING_AFFECTING_WORKFLOWS_CHANGED="${{ steps.changes.outputs.client-publishing-affecting-workflows }}"
          UNIT_TEST_AFFECTING_WORKFLOWS_CHANGED="${{ steps.changes.outputs.unit-test-affecting-workflows }}"
          SECURITY_AFFECTING_WORKFLOWS_CHANGED="${{ steps.changes.outputs.security-affecting-workflows }}"
          
          # Build decision logic with Docker workflow optimization
          SHOULD_RUN_DOCKER="false"
          SHOULD_RUN_E2E="false"
          SHOULD_RUN_TESTS="false"
          SHOULD_RUN_CLIENT_PUBLISHING="false"
          
          # OPTIMIZATION: Only Docker-affecting workflows trigger Docker builds (not ALL workflow changes)
          # CRITICAL: Include docker-security-workflows for security scanning validation
          if [[ "$WEBAUTHN_SERVER_CHANGED" == "true" || "$TEST_CREDS_SERVICE_CHANGED" == "true" || "$DOCKER_AFFECTING_WORKFLOWS_CHANGED" == "true" || "$DOCKER_SECURITY_WORKFLOWS_CHANGED" == "true" ]]; then
            SHOULD_RUN_DOCKER="true"
            SHOULD_RUN_E2E="true"
            SHOULD_RUN_TESTS="true"
          fi
          
          # E2E tests should run for OpenAPI changes, E2E test changes, and E2E-affecting workflow changes
          if [[ "$OPENAPI_CHANGED" == "true" || "$E2E_TESTS_CHANGED" == "true" || "$E2E_TEST_AFFECTING_WORKFLOWS_CHANGED" == "true" ]]; then
            SHOULD_RUN_E2E="true"
          fi
          
          # Unit tests should run for unit test workflow changes
          if [[ "$UNIT_TEST_AFFECTING_WORKFLOWS_CHANGED" == "true" ]]; then
            SHOULD_RUN_TESTS="true"
          fi
          
          # Client publishing should run for OpenAPI changes or client publishing workflow changes
          if [[ "$OPENAPI_CHANGED" == "true" || "$CLIENT_PUBLISHING_AFFECTING_WORKFLOWS_CHANGED" == "true" ]]; then
            SHOULD_RUN_CLIENT_PUBLISHING="true"
          fi
          
          # Set outputs
          echo "webauthn-server-changed=$WEBAUTHN_SERVER_CHANGED" >> $GITHUB_OUTPUT
          echo "test-credentials-service-changed=$TEST_CREDS_SERVICE_CHANGED" >> $GITHUB_OUTPUT
          echo "e2e-tests-changed=$E2E_TESTS_CHANGED" >> $GITHUB_OUTPUT
          echo "workflows-changed=$WORKFLOWS_CHANGED" >> $GITHUB_OUTPUT
          echo "docker-affecting-workflows-changed=$DOCKER_AFFECTING_WORKFLOWS_CHANGED" >> $GITHUB_OUTPUT
          echo "docker-security-workflows-changed=$DOCKER_SECURITY_WORKFLOWS_CHANGED" >> $GITHUB_OUTPUT
          echo "e2e-test-affecting-workflows-changed=$E2E_TEST_AFFECTING_WORKFLOWS_CHANGED" >> $GITHUB_OUTPUT
          echo "client-publishing-affecting-workflows-changed=$CLIENT_PUBLISHING_AFFECTING_WORKFLOWS_CHANGED" >> $GITHUB_OUTPUT
          echo "unit-test-affecting-workflows-changed=$UNIT_TEST_AFFECTING_WORKFLOWS_CHANGED" >> $GITHUB_OUTPUT
          echo "security-affecting-workflows-changed=$SECURITY_AFFECTING_WORKFLOWS_CHANGED" >> $GITHUB_OUTPUT
          
          # Granular E2E outputs
          echo "web-e2e-test-files-changed=$WEB_E2E_FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "android-e2e-test-files-changed=$ANDROID_E2E_FILES_CHANGED" >> $GITHUB_OUTPUT
          
          echo "should-run-docker-workflow=$SHOULD_RUN_DOCKER" >> $GITHUB_OUTPUT
          echo "should-run-e2e-workflow=$SHOULD_RUN_E2E" >> $GITHUB_OUTPUT
          echo "should-run-tests-workflow=$SHOULD_RUN_TESTS" >> $GITHUB_OUTPUT
          echo "should-run-client-publishing-workflow=$SHOULD_RUN_CLIENT_PUBLISHING" >> $GITHUB_OUTPUT
          
          echo "📊 Component Change Summary:"
          echo "  webauthn-server: $WEBAUTHN_SERVER_CHANGED"
          echo "  test-credentials-service: $TEST_CREDS_SERVICE_CHANGED"
          echo "  e2e-tests: $E2E_TESTS_CHANGED"
          echo "  web-e2e-test-files: $WEB_E2E_FILES_CHANGED"
          echo "  android-e2e-test-files: $ANDROID_E2E_FILES_CHANGED"
          echo "  workflows: $WORKFLOWS_CHANGED"
          echo "  docker-affecting-workflows: $DOCKER_AFFECTING_WORKFLOWS_CHANGED"
          echo "  docker-security-workflows: $DOCKER_SECURITY_WORKFLOWS_CHANGED"
          echo "  e2e-test-affecting-workflows: $E2E_TEST_AFFECTING_WORKFLOWS_CHANGED"
          echo "  client-publishing-affecting-workflows: $CLIENT_PUBLISHING_AFFECTING_WORKFLOWS_CHANGED"
          echo "  unit-test-affecting-workflows: $UNIT_TEST_AFFECTING_WORKFLOWS_CHANGED"
          echo "  security-affecting-workflows: $SECURITY_AFFECTING_WORKFLOWS_CHANGED"
          echo "🚀 Build Decisions (Optimized):"  
          echo "  run-docker-workflow: $SHOULD_RUN_DOCKER (triggers: server/creds changes OR docker-affecting workflows OR docker-security workflows)"
          echo "  run-e2e-workflow: $SHOULD_RUN_E2E (triggers: OpenAPI/E2E changes OR e2e-test-affecting workflows)"
          echo "  run-tests-workflow: $SHOULD_RUN_TESTS (triggers: server/creds changes OR unit-test-affecting workflows)"
          echo "  run-client-publishing-workflow: $SHOULD_RUN_CLIENT_PUBLISHING (triggers: OpenAPI changes OR client-publishing workflows)"