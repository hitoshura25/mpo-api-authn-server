name: WebAuthn Vulnerability Monitor

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  monitor-vulnerabilities:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install dependencies
        run: |
          npm install
          chmod +x scripts/monitoring/vulnerability-monitor.js

      - name: Install AI dependencies (optional)
        run: |
          # Install AI SDK for enhanced analysis (optional)
          npm install @anthropic-ai/sdk || echo "⚠️ AI SDK not installed - using standard analysis"

      - name: Run AI-enhanced vulnerability monitoring
        id: monitor
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          chmod +x scripts/monitoring/enhanced-monitor.sh
          scripts/monitoring/enhanced-monitor.sh

      - name: Run security tests
        if: steps.monitor.outputs.no_changes == 'false'
        run: |
          ./gradlew test --tests="*VulnerabilityProtectionTest*"

      - name: Create Pull Request
        if: steps.monitor.outputs.no_changes == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Add tests for new WebAuthn vulnerabilities

            🤖 Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>
          title: 'Security: AI-Enhanced tests for new WebAuthn vulnerabilities'
          body: |
            ## 🤖 AI-Enhanced Vulnerability Update

            This PR was automatically generated by the **AI-enhanced vulnerability monitoring system**.

            ### 🔍 AI Enhancement Features
            - 🤖 **Complete test implementations** (not just stubs) with AI-generated logic
            - 📊 **Codebase-specific risk assessment** for each vulnerability
            - 🔗 **Library correlation analysis** with java-webauthn-server protections
            - 🧪 **Attack simulation patterns** in generated tests
            - 📋 **Prioritized recommendations** based on actual risk to our implementation

            ### Changes Made
            - ✅ Added AI-generated vulnerability tests to `VulnerabilityProtectionTest.kt`
            - ✅ Updated vulnerability tracking with enhanced analysis
            - ✅ Ran existing security test suite to ensure compatibility
            - 🤖 Enhanced with codebase-specific security analysis

            ### New Vulnerabilities Detected
            Details include AI analysis of impact on our specific WebAuthn implementation.
            Check the commit messages and vulnerability-tracking.json for comprehensive analysis.

            ### Testing Quality
            - [x] All existing security tests pass
            - [x] New vulnerability tests include complete implementations
            - [x] AI-generated tests include attack simulation
            - [ ] Manual security review recommended (despite AI enhancement)

            ### AI Analysis Results
            🔍 **Security Analysis**: Each vulnerability assessed against our KTor + Yubico architecture
            🧪 **Test Quality**: AI-generated tests include realistic attack scenarios
            📊 **Risk Assessment**: Prioritized by actual impact on our implementation

            ### Next Steps
            1. Review AI analysis results for each vulnerability
            2. Validate AI-generated test implementations
            3. Check if any immediate actions are required
            4. Run security tests: `./gradlew test --tests="*VulnerabilityProtectionTest*"`
            5. Merge when security review complete

            **⚠️ This PR includes AI-enhanced analysis but still requires human security review**

            ---
            🤖 Generated with [Claude Code](https://claude.ai/code)
          branch: security/vulnerability-updates-${{ github.run_number }}
          delete-branch: true

      - name: Add security label
        if: steps.monitor.outputs.no_changes == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          chmod +x scripts/ci/add-vulnerability-pr-labels.cjs
          node scripts/ci/add-vulnerability-pr-labels.cjs

      - name: Upload monitoring results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-monitor-results
          path: monitor-output.txt
