# Client Library Publishing Orchestrator - Simplified Parallel Architecture
#
# This orchestrator workflow coordinates independent TypeScript and Android client
# generation and publishing workflows for maximum parallelization and platform
# team ownership.
#
# SIMPLIFIED DESIGN PATTERN:
# - Each platform workflow is completely self-contained (generation + publishing)
# - No artifact sharing - each platform handles its own OpenAPI client generation
# - True parallel execution with independent failure isolation
# - Platform teams can own and maintain their specific workflows
#
# PERFORMANCE BENEFITS:
# - 50%+ faster than sequential execution
# - Independent platform failures don't block each other
# - No artifact upload/download overhead
# - True parallelism from start to finish
#
# INPUTS:
#   publish-type: 'staging' or 'production'
#   client-version: Version for client libraries (e.g., 'pr-123.456' or '1.0.32')
#   workflow-identifier: Workflow identifier (required for staging, ignored for production)
#
# OUTPUTS:
#   typescript-package-name: Full TypeScript package name published
#   android-package-name: Full Android Maven coordinates published
#   staging-published: Whether staging packages were published
#   production-published: Whether production packages were published
#   typescript-published: Whether TypeScript package was published
#   typescript-skipped: Whether TypeScript publishing was skipped
#   android-published: Whether Android package was published
#   android-skipped: Whether Android publishing was skipped

name: Client Library Publishing Orchestrator

on:
  workflow_call:
    inputs:
      publish-type:
        description: 'Publishing type (staging/production)'
        required: true
        type: string
        default: 'staging'
      client-version:
        description: 'Version for client libraries'
        required: true
        type: string
      workflow-identifier:
        description: 'Workflow identifier (for staging only)'
        required: false
        type: string
    secrets:
      GRADLE_ENCRYPTION_KEY:
        description: 'Gradle build cache encryption key'
        required: true
      NPM_PUBLISH_TOKEN:
        description: 'npm publishing token (required for production publishing)'
        required: false
      CENTRAL_PORTAL_USERNAME:
        description: 'Maven Central Portal username'
        required: false
      CENTRAL_PORTAL_PASSWORD:
        description: 'Maven Central Portal password'
        required: false
      SIGNING_KEY:
        description: 'GPG signing key for Maven Central'
        required: false
      SIGNING_PASSWORD:
        description: 'GPG signing key password'
        required: false
    outputs:
      # Backward-compatible outputs for existing calling workflows
      typescript-package-name:
        description: 'TypeScript package name published'
        value: ${{ jobs.aggregate-results.outputs.typescript-package-name }}
      android-package-name:
        description: 'Android Maven coordinates published'
        value: ${{ jobs.aggregate-results.outputs.android-package-name }}
      staging-published:
        description: 'Whether staging packages were published'
        value: ${{ jobs.aggregate-results.outputs.staging-published }}
      production-published:
        description: 'Whether production packages were published'
        value: ${{ jobs.aggregate-results.outputs.production-published }}
      # New granular outputs for advanced monitoring
      typescript-published:
        description: 'Whether TypeScript package was actually published (not skipped)'
        value: ${{ jobs.aggregate-results.outputs.typescript-published }}
      typescript-skipped:
        description: 'Whether TypeScript package publishing was skipped (version exists)'
        value: ${{ jobs.aggregate-results.outputs.typescript-skipped }}
      android-published:
        description: 'Whether Android package was actually published (not skipped)'
        value: ${{ jobs.aggregate-results.outputs.android-published }}
      android-skipped:
        description: 'Whether Android package publishing was skipped (version exists)'
        value: ${{ jobs.aggregate-results.outputs.android-skipped }}

env:
  # Central configuration file path
  PUBLISHING_CONFIG_FILE: "config/publishing-config.yml"

jobs:
  # Job 1: Input validation and shared configuration
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      validated: ${{ steps.validation.outputs.validated }}
    steps:
      - name: Validate workflow inputs
        id: validation
        run: |
          echo "ðŸ” Validating workflow inputs..."
          echo "  Publish type: ${{ inputs.publish-type }}"
          echo "  Client version: ${{ inputs.client-version }}"
          echo "  Workflow identifier: ${{ inputs.workflow-identifier }}"
          echo "  NPM scope: ${{ inputs.npm-scope }}"

          if [[ "${{ inputs.publish-type }}" != "staging" && "${{ inputs.publish-type }}" != "production" ]]; then
            echo "âŒ Invalid publish-type: ${{ inputs.publish-type }}"
            echo "   Must be 'staging' or 'production'"
            exit 1
          fi

          # For staging publishes, workflow-identifier is required but can be fallback values for main branch
          if [[ "${{ inputs.publish-type }}" == "staging" && -z "${{ inputs.workflow-identifier }}" ]]; then
            echo "âŒ Workflow identifier is required for staging publishes (can be fallback value like 'main')"
            exit 1
          fi

          # Accept fallback workflow-identifier values for main branch staging publishes
          # Main branch pushes use staging publishes with fallback workflow-identifier values like 'main' or run number
          if [[ "${{ inputs.publish-type }}" == "staging" ]]; then
            echo "âœ… Staging publish with workflow-identifier: ${{ inputs.workflow-identifier }}"
            if [[ "${{ inputs.workflow-identifier }}" == "main" ]]; then
              echo "   (Main branch staging publish - will use run number for unique versioning)"
            elif [[ "${{ inputs.workflow-identifier }}" =~ ^[0-9]+$ ]]; then
              echo "   (PR staging publish)"
            else
              echo "   (Custom staging publish identifier)"
            fi
          fi

          echo "âœ… Input validation passed"
          echo "validated=true" >> $GITHUB_OUTPUT

  # Job 2: Load central configuration and create job outputs (required for callable workflows)
  setup-config:
    runs-on: ubuntu-latest
    outputs:
      # Package configuration outputs
      npm-scope: ${{ steps.config.outputs.npm-scope }}
      npm-package-name: ${{ steps.config.outputs.npm-package-name }}
      android-group-id: ${{ steps.config.outputs.android-group-id }}
      android-artifact-base-id: ${{ steps.config.outputs.android-artifact-base-id }}
      # Environment-specific repository configuration outputs (selected based on publish-type)
      npm-registry-url: ${{ steps.config.outputs.npm-registry-url }}
      npm-credential-env: ${{ steps.config.outputs.npm-credential-env }}
      npm-suffix: ${{ steps.config.outputs.npm-suffix }}
      android-repository-url: ${{ steps.config.outputs.android-repository-url }}
      android-username-env: ${{ steps.config.outputs.android-username-env }}
      android-password-env: ${{ steps.config.outputs.android-password-env }}
      # android-username-property and android-password-property removed - hardcoded in template
      android-suffix: ${{ steps.config.outputs.android-suffix }}
    steps:
      - name: Checkout code for configuration
        uses: actions/checkout@v4

      - name: Load central configuration
        id: config
        run: |
          echo "ðŸ”§ Loading central configuration from ${{ env.PUBLISHING_CONFIG_FILE }}..."
          
          # Validate configuration file exists
          if [[ ! -f "${{ env.PUBLISHING_CONFIG_FILE }}" ]]; then
            echo "âŒ Configuration file not found: ${{ env.PUBLISHING_CONFIG_FILE }}"
            exit 1
          fi

          # Verify yq is available (pre-installed on ubuntu-latest runners)
          if ! command -v yq &> /dev/null; then
            echo "âŒ yq not found. Using pre-installed version on ubuntu-latest runners."
            exit 1
          fi
          echo "âœ… Using pre-installed yq: $(yq --version)"

          # Load package configuration from centralized config
          NPM_BASE_NAME=$(yq '.packages.typescript.basePackageName' ${{ env.PUBLISHING_CONFIG_FILE }})
          
          # Select environment-specific npm scope based on publish-type
          PUBLISH_TYPE="${{ inputs.publish-type }}"
          NPM_SCOPE=$(yq ".packages.typescript.scope.${PUBLISH_TYPE}" ${{ env.PUBLISHING_CONFIG_FILE }})
          
          echo "â„¹ï¸ Using npm-scope from central config for ${PUBLISH_TYPE} environment: ${NPM_SCOPE}"
          ANDROID_GROUP_ID=$(yq '.packages.android.groupId' ${{ env.PUBLISHING_CONFIG_FILE }})
          ANDROID_ARTIFACT_BASE_ID=$(yq '.packages.android.baseArtifactId' ${{ env.PUBLISHING_CONFIG_FILE }})

          # Load environment-specific configuration (PUBLISH_TYPE already set above)
          echo "ðŸŽ¯ Loading configuration for environment: ${PUBLISH_TYPE}"

          # Load repository configuration for selected environment
          NPM_REGISTRY_URL=$(yq ".repositories.${PUBLISH_TYPE}.npm.registry" ${{ env.PUBLISHING_CONFIG_FILE }})
          NPM_CREDENTIAL_ENV=$(yq ".repositories.${PUBLISH_TYPE}.npm.credentials.tokenEnv" ${{ env.PUBLISHING_CONFIG_FILE }})
          
          ANDROID_REPO_URL=$(yq ".repositories.${PUBLISH_TYPE}.android.url" ${{ env.PUBLISHING_CONFIG_FILE }})
          ANDROID_USERNAME_ENV=$(yq ".repositories.${PUBLISH_TYPE}.android.credentials.usernameEnv" ${{ env.PUBLISHING_CONFIG_FILE }})
          ANDROID_PASSWORD_ENV=$(yq ".repositories.${PUBLISH_TYPE}.android.credentials.passwordEnv" ${{ env.PUBLISHING_CONFIG_FILE }})
          # Property names are hardcoded as "PublishingRepositoryUsername" and "PublishingRepositoryPassword"
          # in the Android template since the repository name is hardcoded as "PublishingRepository"
          
          # Load package suffix configuration for selected environment
          NPM_SUFFIX=$(yq ".naming.${PUBLISH_TYPE}.npmSuffix" ${{ env.PUBLISHING_CONFIG_FILE }})
          ANDROID_SUFFIX=$(yq ".naming.${PUBLISH_TYPE}.androidSuffix" ${{ env.PUBLISHING_CONFIG_FILE }})

          # Validate all required values are present
          if [[ -z "$NPM_SCOPE" || "$NPM_BASE_NAME" == "null" || "$ANDROID_GROUP_ID" == "null" || "$ANDROID_ARTIFACT_BASE_ID" == "null" ]]; then
            echo "âŒ Missing required package configuration:"
            echo "  NPM_SCOPE: '${NPM_SCOPE}'"
            echo "  NPM_BASE_NAME: '${NPM_BASE_NAME}'"
            echo "  ANDROID_GROUP_ID: '${ANDROID_GROUP_ID}'"
            echo "  ANDROID_ARTIFACT_BASE_ID: '${ANDROID_ARTIFACT_BASE_ID}'"
            exit 1
          fi

          if [[ "$NPM_REGISTRY_URL" == "null" || "$ANDROID_REPO_URL" == "null" ]]; then
            echo "âŒ Missing required repository configuration for ${PUBLISH_TYPE} environment in ${{ env.PUBLISHING_CONFIG_FILE }}"
            echo "  NPM_REGISTRY_URL: '${NPM_REGISTRY_URL}'"
            echo "  ANDROID_REPO_URL: '${ANDROID_REPO_URL}'"
            exit 1
          fi

          # Set outputs for package configuration (backward compatibility)
          echo "npm-scope=${NPM_SCOPE}" >> $GITHUB_OUTPUT
          echo "npm-package-name=${NPM_BASE_NAME}" >> $GITHUB_OUTPUT
          echo "android-group-id=${ANDROID_GROUP_ID}" >> $GITHUB_OUTPUT
          echo "android-artifact-base-id=${ANDROID_ARTIFACT_BASE_ID}" >> $GITHUB_OUTPUT

          # Set outputs for selected environment repository configuration
          echo "npm-registry-url=${NPM_REGISTRY_URL}" >> $GITHUB_OUTPUT
          echo "npm-credential-env=${NPM_CREDENTIAL_ENV}" >> $GITHUB_OUTPUT
          echo "npm-suffix=${NPM_SUFFIX}" >> $GITHUB_OUTPUT
          
          echo "android-repository-url=${ANDROID_REPO_URL}" >> $GITHUB_OUTPUT
          echo "android-username-env=${ANDROID_USERNAME_ENV}" >> $GITHUB_OUTPUT
          echo "android-password-env=${ANDROID_PASSWORD_ENV}" >> $GITHUB_OUTPUT
          # android-username-property and android-password-property no longer needed - hardcoded in template
          echo "android-suffix=${ANDROID_SUFFIX}" >> $GITHUB_OUTPUT

          echo "âœ… Central configuration loaded successfully for ${PUBLISH_TYPE} environment:"
          echo "  NPM package: ${NPM_SCOPE}/${NPM_BASE_NAME} (scope from config: ${PUBLISH_TYPE})"
          echo "  NPM registry: ${NPM_REGISTRY_URL}"
          echo "  NPM suffix: '${NPM_SUFFIX}'"
          echo "  Android package: ${ANDROID_GROUP_ID}:${ANDROID_ARTIFACT_BASE_ID}"
          echo "  Android repository: ${ANDROID_REPO_URL}"
          echo "  Android suffix: '${ANDROID_SUFFIX}'"
          echo "  Android username property: PublishingRepositoryUsername (hardcoded)"
          echo "  Android password property: PublishingRepositoryPassword (hardcoded)"

  # Job 3: TypeScript client generation and publishing (parallel)
  publish-typescript:
    uses: ./.github/workflows/publish-typescript.yml
    needs: [ validate-inputs, setup-config ]
    if: needs.validate-inputs.outputs.validated == 'true'
    permissions:
      contents: write   # Required for creating GitHub releases (production only)
      packages: write    # Required for GitHub Packages publishing
      id-token: write   # Required for npm provenance in production
    with:
      publish-type: ${{ inputs.publish-type }}
      client-version: ${{ inputs.client-version }}
      npm-scope: ${{ needs.setup-config.outputs.npm-scope }}
      npm-package-name: ${{ needs.setup-config.outputs.npm-package-name }}
      npm-registry-url: ${{ needs.setup-config.outputs.npm-registry-url }}
      npm-credential-env: ${{ needs.setup-config.outputs.npm-credential-env }}
      npm-suffix: ${{ needs.setup-config.outputs.npm-suffix }}
      android-group-id: ${{ needs.setup-config.outputs.android-group-id }}  # Needed for Gradle generation
    secrets:
      GRADLE_ENCRYPTION_KEY: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
      NPM_PUBLISH_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}

  # Job 4: Android client generation and publishing (parallel)
  publish-android:
    uses: ./.github/workflows/publish-android.yml
    needs: [ validate-inputs, setup-config ]
    if: needs.validate-inputs.outputs.validated == 'true'
    permissions:
      contents: write   # Required for creating GitHub releases (production only)
      packages: write   # Required for GitHub Packages publishing
    with:
      publish-type: ${{ inputs.publish-type }}
      client-version: ${{ inputs.client-version }}
      android-group-id: ${{ needs.setup-config.outputs.android-group-id }}
      android-artifact-base-id: ${{ needs.setup-config.outputs.android-artifact-base-id }}
      # Environment-specific repository configuration from central config
      android-repository-url: ${{ needs.setup-config.outputs.android-repository-url }}
      android-username-env: ${{ needs.setup-config.outputs.android-username-env }}
      android-password-env: ${{ needs.setup-config.outputs.android-password-env }}
      # android-username-property and android-password-property removed - hardcoded in template
      android-suffix: ${{ needs.setup-config.outputs.android-suffix }}
    secrets:
      GRADLE_ENCRYPTION_KEY: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
      CENTRAL_PORTAL_USERNAME: ${{ secrets.CENTRAL_PORTAL_USERNAME }}
      CENTRAL_PORTAL_PASSWORD: ${{ secrets.CENTRAL_PORTAL_PASSWORD }}
      SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
      SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}

  # Job 5: Aggregate results and provide backward-compatible outputs
  aggregate-results:
    needs: [ validate-inputs, setup-config, publish-typescript, publish-android ]
    runs-on: ubuntu-latest
    # Always run to provide outputs, even if publishing jobs failed
    if: always() && needs.validate-inputs.outputs.validated == 'true'
    outputs:
      # Backward-compatible outputs for existing calling workflows
      typescript-package-name: ${{ needs.publish-typescript.outputs.package-name }}
      android-package-name: ${{ needs.publish-android.outputs.package-name }}
      staging-published: ${{ steps.aggregate-status.outputs.staging-published }}
      production-published: ${{ steps.aggregate-status.outputs.production-published }}
      # New granular outputs for advanced usage
      typescript-published: ${{ needs.publish-typescript.outputs.published }}
      typescript-skipped: ${{ needs.publish-typescript.outputs.skipped }}
      android-published: ${{ needs.publish-android.outputs.published }}
      android-skipped: ${{ needs.publish-android.outputs.skipped }}
    steps:
      - name: Aggregate publishing status
        id: aggregate-status
        run: |
          echo "ðŸ“Š Aggregating publishing results..."
          echo "  TypeScript result: ${{ needs.publish-typescript.result }}"
          echo "  TypeScript published: ${{ needs.publish-typescript.outputs.published }}"
          echo "  TypeScript skipped: ${{ needs.publish-typescript.outputs.skipped }}"
          echo "  Android result: ${{ needs.publish-android.result }}"
          echo "  Android published: ${{ needs.publish-android.outputs.published }}"
          echo "  Android skipped: ${{ needs.publish-android.outputs.skipped }}"

          # Determine overall staging/production status for backward compatibility
          if [[ "${{ inputs.publish-type }}" == "staging" ]]; then
            # For staging, consider published if either platform was published (not skipped)
            # Handle job failures gracefully
            TS_PUBLISHED="false"
            ANDROID_PUBLISHED="false"

            if [[ "${{ needs.publish-typescript.result }}" == "success" && "${{ needs.publish-typescript.outputs.published }}" == "true" ]]; then
              TS_PUBLISHED="true"
            fi

            if [[ "${{ needs.publish-android.result }}" == "success" && "${{ needs.publish-android.outputs.published }}" == "true" ]]; then
              ANDROID_PUBLISHED="true"
            fi

            if [[ "${TS_PUBLISHED}" == "true" || "${ANDROID_PUBLISHED}" == "true" ]]; then
              echo "staging-published=true" >> $GITHUB_OUTPUT
            else
              echo "staging-published=false" >> $GITHUB_OUTPUT
            fi
            echo "production-published=false" >> $GITHUB_OUTPUT
          else
            echo "staging-published=false" >> $GITHUB_OUTPUT
            # For production, consider published if both platforms succeeded
            if [[ "${{ needs.publish-typescript.result }}" == "success" && "${{ needs.publish-android.result }}" == "success" ]]; then
              echo "production-published=true" >> $GITHUB_OUTPUT
            else
              echo "production-published=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Publishing summary
        run: |
          echo "ðŸŽ¯ Client Library Publishing Summary (Simplified Parallel Architecture):"
          echo "  Publish type: ${{ inputs.publish-type }}"
          echo ""
          echo "  ðŸ“¦ TypeScript Results:"
          echo "    Package: ${{ needs.publish-typescript.outputs.package-name }}"
          echo "    Status: ${{ needs.publish-typescript.result }}"
          echo "    Published: ${{ needs.publish-typescript.outputs.published }}"
          echo "    Skipped: ${{ needs.publish-typescript.outputs.skipped }}"
          echo ""
          echo "  ðŸ“± Android Results:"
          echo "    Package: ${{ needs.publish-android.outputs.package-name }}"
          echo "    Status: ${{ needs.publish-android.result }}"
          echo "    Published: ${{ needs.publish-android.outputs.published }}"
          echo "    Skipped: ${{ needs.publish-android.outputs.skipped }}"
          echo ""
          echo "  ðŸŽ¯ Overall Results:"
          echo "    Staging published: ${{ steps.aggregate-status.outputs.staging-published }}"
          echo "    Production published: ${{ steps.aggregate-status.outputs.production-published }}"
          echo ""
          echo "  âš¡ Performance: True parallel execution - no artifact sharing overhead"
