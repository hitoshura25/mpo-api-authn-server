# E2E Tests Orchestrator - Cross-Platform Integration
#
# This workflow orchestrates comprehensive end-to-end tests using built Docker images
# to ensure full system integration works correctly across all platforms.
#
# ARCHITECTURE:
# - Orchestrates parallel execution of platform-specific E2E workflows
# - Web E2E: Delegates to web-e2e-tests.yml (Playwright testing)
# - Android E2E: Delegates to android-e2e-tests.yml (emulator testing)
# - Results aggregation: Collects and reports results from both platforms
#
# TRIGGER CONDITIONS:
# - Called by main orchestrator workflow (main-ci-cd.yml)
# - Only runs when Docker images have been successfully built
# - Uses the exact images that were built for the PR
#
# TEST COVERAGE:
# - Cross-platform WebAuthn functionality (Android + Web)
# - Full API contract validation
# - Integration between all services
# - Real Docker image validation
#
# BENEFITS:
# - True parallel execution of platform tests
# - Independent platform team ownership
# - Selective test execution capabilities
# - Improved maintainability and specialization

name: E2E Tests - Cross-Platform Orchestrator

on:
  workflow_call:
    inputs:
      webauthn_server_image:
        description: 'WebAuthn server Docker image tag'
        required: true
        type: string
      test_credentials_image:
        description: 'Test credentials service Docker image tag'
        required: true
        type: string
      webauthn_server_digest:
        description: 'WebAuthn server Docker image digest (for content-based caching)'
        required: true
        type: string
      test_credentials_digest:
        description: 'Test credentials service Docker image digest (for content-based caching)'
        required: true
        type: string
      workflow-identifier:
        description: 'Workflow identifier for artifact naming (PR number or fallback value for main branch)'
        required: false
        type: string
        default: ''
      # Component change detection inputs for smart E2E triggering
      webauthn-server-changed:
        description: 'Whether webauthn-server component changed'
        required: false
        default: 'false'
        type: string
      test-credentials-service-changed:
        description: 'Whether test-credentials-service component changed'
        required: false
        default: 'false'
        type: string
      should-run-client-publishing-workflow:
        description: 'Whether client publishing workflow should be executed (based on OpenAPI or workflow changes)'
        required: false
        default: 'false'
        type: string
      e2e-tests-changed:
        description: 'Whether E2E test files changed'
        required: false
        default: 'false'
        type: string
      # Granular E2E change inputs for platform-specific triggering
      web-e2e-test-files-changed:
        description: 'Whether web E2E test files changed'
        required: false
        default: 'false'
        type: string
      android-e2e-test-files-changed:
        description: 'Whether Android E2E test files changed'
        required: false
        default: 'false'
        type: string
      # Security scanning inputs
      security-scan-files-changed:
        description: 'Whether security scan configuration changed'
        required: false
        default: 'false'
        type: string
      # Force execution flags
      force-full-pipeline:
        description: 'Force full E2E pipeline execution'
        required: false
        default: false
        type: boolean
      force-docker-build:
        description: 'Force E2E tests due to Docker build'
        required: false
        default: false
        type: boolean
      # Client library information (from actual published packages)
      typescript-package-name:
        description: 'Published TypeScript package name'
        required: false
        type: string
        default: ''
      android-package-name:
        description: 'Published Android package name'
        required: false
        type: string
        default: ''
      client-version:
        description: 'Published client library version'
        required: false
        type: string
        default: ''

env:
  ANDROID_API_VERSION: "29"
  JAVA_VERSION: "21"
  # Use workflow inputs directly
  WORKFLOW_IDENTIFIER: ${{ github.event.pull_request.number || github.run_number || 'main' }}
  WEBAUTHN_SERVER_IMAGE: ${{ inputs.webauthn_server_image }}
  TEST_CREDENTIALS_IMAGE: ${{ inputs.test_credentials_image }}
  BASE_VERSION: "1.0"
  PUBLISHING_CONFIG_FILE: "config/publishing-config.yml"

jobs:
  # Job 1: Setup configuration for callable workflows (convert env vars to job outputs)
  setup-config:
    runs-on: ubuntu-latest
    outputs:
      java-version: ${{ steps.config.outputs.java-version }}
      android-api-version: ${{ steps.config.outputs.android-api-version }}
      docker-registry: ${{ steps.config.outputs.docker-registry }}
      # Client library information (passed through from main orchestrator)
      client-version: ${{ steps.config.outputs.client-version }}
      typescript-package-name: ${{ steps.config.outputs.typescript-package-name }}
      android-package-name: ${{ steps.config.outputs.android-package-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Load configuration from central config file
        id: config
        run: |
          echo "ðŸ”§ Loading configuration from ${{ env.PUBLISHING_CONFIG_FILE }}..."

          # Load configuration (yq is pre-installed on GitHub runners)
          CONFIG_FILE="${{ env.PUBLISHING_CONFIG_FILE }}"

          # Validate configuration file exists
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ Configuration file not found: $CONFIG_FILE"
            exit 1
          fi

          # Extract configuration values (E2E tests use staging environment)
          DOCKER_REGISTRY=$(yq '.docker.registry.url' "$CONFIG_FILE")

          # Validate required values are not null
          if [ "$DOCKER_REGISTRY" = "null" ]; then
            echo "âŒ Missing required configuration in $CONFIG_FILE"
            echo "Docker registry: $DOCKER_REGISTRY"
            exit 1
          fi

          # Set outputs (mix of central config and environment variables)
          echo "java-version=${{ env.JAVA_VERSION }}" >> $GITHUB_OUTPUT
          echo "android-api-version=${{ env.ANDROID_API_VERSION }}" >> $GITHUB_OUTPUT
          echo "docker-registry=$DOCKER_REGISTRY" >> $GITHUB_OUTPUT

          # Pass through client library information from main orchestrator
          echo "client-version=${{ inputs.client-version }}" >> $GITHUB_OUTPUT
          echo "typescript-package-name=${{ inputs.typescript-package-name }}" >> $GITHUB_OUTPUT
          echo "android-package-name=${{ inputs.android-package-name }}" >> $GITHUB_OUTPUT

          echo "âœ… Configuration loaded successfully:"
          echo "  Docker registry: $DOCKER_REGISTRY (from central config)"
          echo "  Java version: ${{ env.JAVA_VERSION }} (from environment)"
          echo "  Client version: ${{ inputs.client-version }} (from main orchestrator)"
          echo "  TypeScript package: ${{ inputs.typescript-package-name }} (from main orchestrator)"
          echo "  Android package: ${{ inputs.android-package-name }} (from main orchestrator)"

  # Job 2: Component-aware E2E test orchestration with intelligent scope determination
  analyze-e2e-requirements:
    runs-on: ubuntu-latest
    needs: setup-config
    outputs:
      web-cache-hit: ${{ steps.web-cache.outputs.cache-hit }}
      android-cache-hit: ${{ steps.android-cache.outputs.cache-hit }}
      dast-cache-hit: ${{ steps.dast-cache.outputs.cache-hit }}
      cache-key-web: ${{ steps.cache-keys.outputs.web-key }}
      cache-key-android: ${{ steps.cache-keys.outputs.android-key }}
      cache-key-dast: ${{ steps.cache-keys.outputs.dast-key }}
      # Simplified single flags - no more redundant should-run vs skip logic
      run-web-e2e: ${{ steps.determine-scope.outputs.run-web-e2e }}
      run-android-e2e: ${{ steps.determine-scope.outputs.run-android-e2e }}
      run-dast-scan: ${{ steps.determine-scope.outputs.run-dast-scan }}
      use-web-cache: ${{ steps.determine-scope.outputs.use-web-cache }}
      use-android-cache: ${{ steps.determine-scope.outputs.use-android-cache }}
      use-dast-cache: ${{ steps.determine-scope.outputs.use-dast-cache }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate E2E cache keys
        id: cache-keys
        run: |
          # Extract image digests for cache key (content-based, not tag-based)
          WEBAUTHN_DIGEST="${{ inputs.webauthn_server_digest }}"
          TEST_CREDS_DIGEST="${{ inputs.test_credentials_digest }}"

          # Create short digest versions for cache keys (first 12 chars of hash)
          WEBAUTHN_DIGEST_SHORT=$(echo "$WEBAUTHN_DIGEST" | cut -d':' -f2 | cut -c1-12)
          TEST_CREDS_DIGEST_SHORT=$(echo "$TEST_CREDS_DIGEST" | cut -d':' -f2 | cut -c1-12)

          # Use dorny-based change detection results for cache keys (eliminating manual file hashing)
          WEB_FILES_CHANGED="${{ inputs.web-e2e-test-files-changed }}"
          ANDROID_FILES_CHANGED="${{ inputs.android-e2e-test-files-changed }}"
          SECURITY_FILES_CHANGED="${{ inputs.security-scan-files-changed }}"

          # Create cache discriminator based on image content (digests) and change detection
          WEB_CACHE_DISCRIMINATOR=$(echo "${WEB_FILES_CHANGED}-${WEBAUTHN_DIGEST_SHORT}-${TEST_CREDS_DIGEST_SHORT}" | sha256sum | cut -d' ' -f1)
          ANDROID_CACHE_DISCRIMINATOR=$(echo "${ANDROID_FILES_CHANGED}-${WEBAUTHN_DIGEST_SHORT}-${TEST_CREDS_DIGEST_SHORT}" | sha256sum | cut -d' ' -f1)
          DAST_CACHE_DISCRIMINATOR=$(echo "${SECURITY_FILES_CHANGED}-${WEBAUTHN_DIGEST_SHORT}-${TEST_CREDS_DIGEST_SHORT}" | sha256sum | cut -d' ' -f1)

          # Generate branch/event context for cache key isolation
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CONTEXT_SUFFIX="pr-${{ github.event.pull_request.number }}"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            CONTEXT_SUFFIX="main"
          else
            CONTEXT_SUFFIX="branch-${{ github.ref_name }}"
          fi

          # Create platform-specific cache keys with dorny-based discriminator
          WEB_CACHE_KEY="web-e2e-results-${WEB_CACHE_DISCRIMINATOR}-${CONTEXT_SUFFIX}"
          ANDROID_CACHE_KEY="android-e2e-results-${ANDROID_CACHE_DISCRIMINATOR}-${CONTEXT_SUFFIX}"
          DAST_CACHE_KEY="dast-scan-results-${DAST_CACHE_DISCRIMINATOR}-${CONTEXT_SUFFIX}"

          echo "web-key=${WEB_CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "android-key=${ANDROID_CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "dast-key=${DAST_CACHE_KEY}" >> $GITHUB_OUTPUT

          echo "ðŸ”‘ Cache Keys Generated (Content-Based):"
          echo "  Web E2E: ${WEB_CACHE_KEY}"
          echo "  Android E2E: ${ANDROID_CACHE_KEY}"
          echo "  DAST Scan: ${DAST_CACHE_KEY}"
          echo "ðŸ·ï¸  Image Digests (Content-Based):"
          echo "  WebAuthn: ${WEBAUTHN_DIGEST} â†’ ${WEBAUTHN_DIGEST_SHORT}"
          echo "  Test Creds: ${TEST_CREDS_DIGEST} â†’ ${TEST_CREDS_DIGEST_SHORT}"
          echo "ðŸŽ¯ Change Detection:"
          echo "  Web E2E Files Changed: ${WEB_FILES_CHANGED}"
          echo "  Android E2E Files Changed: ${ANDROID_FILES_CHANGED}"
          echo "  Security Scan Files Changed: ${SECURITY_FILES_CHANGED}"
          echo "  Context: ${CONTEXT_SUFFIX}"

      - name: Check Web E2E cache
        id: web-cache
        uses: actions/cache@v4
        with:
          key: ${{ steps.cache-keys.outputs.web-key }}
          path: |
            web-e2e-cache/
            web-e2e-results.json
          lookup-only: true

      - name: Check Android E2E cache
        id: android-cache
        uses: actions/cache@v4
        with:
          key: ${{ steps.cache-keys.outputs.android-key }}
          path: |
            android-e2e-cache/
            android-e2e-results.json
          lookup-only: true

      - name: Check DAST scan cache
        id: dast-cache
        uses: actions/cache@v4
        with:
          key: ${{ steps.cache-keys.outputs.dast-key }}
          path: |
            dast-scan-cache/
            dast-scan-results.json
          lookup-only: true

      - name: Intelligent E2E test scope determination with component awareness
        id: determine-scope
        run: |
          echo "ðŸ” Analyzing component changes and force flags for intelligent E2E test orchestration..."
          echo "ðŸ“‹ Component Changes:"
          echo "  WebAuthn Server: ${{ inputs.webauthn-server-changed }}"
          echo "  Test Credentials Service: ${{ inputs.test-credentials-service-changed }}"
          echo "  Client Publishing Workflow: ${{ inputs.should-run-client-publishing-workflow }}"
          echo "  E2E Tests: ${{ inputs.e2e-tests-changed }}"
          echo "ðŸ“‹ Force Flags:"
          echo "  Force Full Pipeline: ${{ inputs.force-full-pipeline }}"
          echo "  Force Docker Build: ${{ inputs.force-docker-build }}"
          echo ""

          # Initialize variables - simplified single flag approach
          RUN_WEB="false"
          RUN_ANDROID="false"
          RUN_DAST="false"
          USE_WEB_CACHE="false"
          USE_ANDROID_CACHE="false"
          USE_DAST_CACHE="false"

          # Check if force flags require execution (overrides everything)
          if [[ "${{ inputs.force-full-pipeline }}" == "true" || "${{ inputs.force-docker-build }}" == "true" ]]; then
            RUN_WEB="true"
            RUN_ANDROID="true"
            RUN_DAST="true"
            echo "ðŸš€ Force flags detected - running full E2E test suite including DAST scan (ignoring cache)"
          else
            # Component-specific E2E test triggering logic
            SERVER_CHANGED="${{ inputs.webauthn-server-changed }}"
            CREDS_CHANGED="${{ inputs.test-credentials-service-changed }}"
            API_CHANGED="${{ inputs.should-run-client-publishing-workflow }}"
            E2E_CHANGED="${{ inputs.e2e-tests-changed }}"
            SECURITY_CHANGED="${{ inputs.security-scan-files-changed }}"

            # Determine which tests to run based on component changes
            if [[ "$SERVER_CHANGED" == "true" || "$CREDS_CHANGED" == "true" ]]; then
              # Server components changed: Full E2E test suite including DAST scan required
              RUN_WEB="true"
              RUN_ANDROID="true"
              RUN_DAST="true"
              echo "ðŸ”§ Server components changed - requiring full E2E test suite including DAST scan"
            elif [[ "$API_CHANGED" == "true" ]]; then
              # OpenAPI changed: Focus on client integration tests
              RUN_WEB="true"
              RUN_ANDROID="true"
              echo "ðŸ”„ OpenAPI changed - focusing on client integration validation"
            elif [[ "$E2E_CHANGED" == "true" ]]; then
              # Only E2E tests changed: Use centralized dorny/paths-filter results
              if [[ "${{ inputs.web-e2e-test-files-changed }}" == "true" ]]; then
                RUN_WEB="true"
                echo "ðŸ“± Web E2E test files changed - including web tests"
              fi
              if [[ "${{ inputs.android-e2e-test-files-changed }}" == "true" ]]; then
                RUN_ANDROID="true"
                echo "ðŸ¤– Android E2E test files changed - including Android tests"
              fi
            elif [[ "$SECURITY_CHANGED" == "true" ]]; then
              # Security scan configuration changed: Run DAST scan only
              RUN_DAST="true"
              echo "ðŸ”’ Security scan configuration changed - including DAST scan"
            else
              echo "â„¹ï¸ No components requiring E2E tests or security scans changed"
            fi

            # Apply cache optimization (only when not forced)
            if [[ "$RUN_WEB" == "true" && "${{ steps.web-cache.outputs.cache-hit }}" == "true" ]]; then
              USE_WEB_CACHE="true"
              RUN_WEB="false"  # Use cache instead of running
              echo "ðŸ’¾ Web E2E cache hit - using cached results"
            fi

            if [[ "$RUN_ANDROID" == "true" && "${{ steps.android-cache.outputs.cache-hit }}" == "true" ]]; then
              USE_ANDROID_CACHE="true"
              RUN_ANDROID="false"  # Use cache instead of running
              echo "ðŸ’¾ Android E2E cache hit - using cached results"
            fi

            if [[ "$RUN_DAST" == "true" && "${{ steps.dast-cache.outputs.cache-hit }}" == "true" ]]; then
              USE_DAST_CACHE="true"
              RUN_DAST="false"  # Use cache instead of running
              echo "ðŸ’¾ DAST scan cache hit - using cached results"
            fi
          fi

          # Set outputs - simplified single flag approach
          echo "run-web-e2e=$RUN_WEB" >> $GITHUB_OUTPUT
          echo "run-android-e2e=$RUN_ANDROID" >> $GITHUB_OUTPUT
          echo "run-dast-scan=$RUN_DAST" >> $GITHUB_OUTPUT
          echo "use-web-cache=$USE_WEB_CACHE" >> $GITHUB_OUTPUT
          echo "use-android-cache=$USE_ANDROID_CACHE" >> $GITHUB_OUTPUT
          echo "use-dast-cache=$USE_DAST_CACHE" >> $GITHUB_OUTPUT

          echo ""
          echo "ðŸŽ¯ E2E Test Execution Plan:"
          echo "  Web E2E: $([ "$RUN_WEB" == "true" ] && echo "RUN" || ([ "$USE_WEB_CACHE" == "true" ] && echo "CACHE" || echo "SKIP"))"
          echo "  Android E2E: $([ "$RUN_ANDROID" == "true" ] && echo "RUN" || ([ "$USE_ANDROID_CACHE" == "true" ] && echo "CACHE" || echo "SKIP"))"
          echo "  DAST Scan: $([ "$RUN_DAST" == "true" ] && echo "RUN" || ([ "$USE_DAST_CACHE" == "true" ] && echo "CACHE" || echo "SKIP"))"

      - name: Component-aware execution and cache summary
        run: |
          echo "ðŸ“Š E2E Test Strategy Summary:"
          echo "ðŸ“‹ Component Analysis:"
          echo "  Component triggers: Server=${{ inputs.webauthn-server-changed }}, Creds=${{ inputs.test-credentials-service-changed }}, Client Publishing=${{ inputs.should-run-client-publishing-workflow }}, E2E=${{ inputs.e2e-tests-changed }}, Security=${{ inputs.security-scan-files-changed }}"
          echo ""
          echo "ðŸ’¾ Cache Optimization:"
          echo "  Web E2E cache hit: ${{ steps.web-cache.outputs.cache-hit }}"
          echo "  Android E2E cache hit: ${{ steps.android-cache.outputs.cache-hit }}"
          echo "  DAST scan cache hit: ${{ steps.dast-cache.outputs.cache-hit }}"
          echo ""
          echo "ðŸƒ Final Execution Plan:"
          echo "  Web E2E: ${{ steps.determine-scope.outputs.run-web-e2e == 'true' && 'RUN' || (steps.determine-scope.outputs.use-web-cache == 'true' && 'CACHE' || 'SKIP') }}"
          echo "  Android E2E: ${{ steps.determine-scope.outputs.run-android-e2e == 'true' && 'RUN' || (steps.determine-scope.outputs.use-android-cache == 'true' && 'CACHE' || 'SKIP') }}"
          echo "  DAST Scan: ${{ steps.determine-scope.outputs.run-dast-scan == 'true' && 'RUN' || (steps.determine-scope.outputs.use-dast-cache == 'true' && 'CACHE' || 'SKIP') }}"
          echo "  Parallel Execution: ${{ (steps.determine-scope.outputs.run-web-e2e == 'true' || steps.determine-scope.outputs.run-android-e2e == 'true' || steps.determine-scope.outputs.run-dast-scan == 'true') && 'YES' || 'NO' }}"

  # Job 3: Validate Docker images are available with enhanced coordination
  validate-images:
    runs-on: ubuntu-latest
    needs: [ setup-config, analyze-e2e-requirements ]
    outputs:
      webauthn-server-ready: ${{ steps.check-webauthn.outputs.available }}
      test-credentials-ready: ${{ steps.check-test-credentials.outputs.available }}
    steps:
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ needs.setup-config.outputs.docker-registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check WebAuthn Server image availability
        id: check-webauthn
        run: |
          echo "ðŸ” Checking WebAuthn Server image: ${{ env.WEBAUTHN_SERVER_IMAGE }}"
          if docker manifest inspect "${{ env.WEBAUTHN_SERVER_IMAGE }}" > /dev/null 2>&1; then
            echo "âœ… WebAuthn Server image is available"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ WebAuthn Server image not found"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Test Credentials Service image availability
        id: check-test-credentials
        run: |
          echo "ðŸ” Checking Test Credentials Service image: ${{ env.TEST_CREDENTIALS_IMAGE }}"
          if docker manifest inspect "${{ env.TEST_CREDENTIALS_IMAGE }}" > /dev/null 2>&1; then
            echo "âœ… Test Credentials Service image is available"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Test Credentials Service image not found"
            echo "available=false" >> $GITHUB_OUTPUT
          fi


  # Job 4: Enhanced Web E2E tests with parallel execution optimization
  call-web-e2e-tests:
    uses: ./.github/workflows/web-e2e-tests.yml
    needs: [ setup-config, validate-images, analyze-e2e-requirements ]
    if: |
      needs.validate-images.outputs.webauthn-server-ready == 'true' &&
      needs.validate-images.outputs.test-credentials-ready == 'true' &&
      needs.analyze-e2e-requirements.outputs.run-web-e2e == 'true'
    secrets: inherit
    with:
      webauthn-server-image: ${{ inputs.webauthn_server_image }}
      test-credentials-image: ${{ inputs.test_credentials_image }}
      workflow-identifier: ${{ github.event.pull_request.number || github.run_number || 'main' }}
      java-version: ${{ needs.setup-config.outputs.java-version }}
      # Use actual published client library information from main orchestrator (via setup-config)
      typescript-package-name: ${{ needs.setup-config.outputs.typescript-package-name }}
      client-version: ${{ needs.setup-config.outputs.client-version }}
      should-run-client-publishing-workflow: ${{ inputs.should-run-client-publishing-workflow }}
      cache-key: ${{ needs.analyze-e2e-requirements.outputs.cache-key-web }}

  # Job 5: Enhanced Android E2E tests with parallel execution optimization
  call-android-e2e-tests:
    uses: ./.github/workflows/android-e2e-tests.yml
    needs: [ setup-config, validate-images, analyze-e2e-requirements ]
    if: |
      needs.validate-images.outputs.webauthn-server-ready == 'true' &&
      needs.validate-images.outputs.test-credentials-ready == 'true' &&
      needs.analyze-e2e-requirements.outputs.run-android-e2e == 'true'
    secrets: inherit
    with:
      webauthn-server-image: ${{ inputs.webauthn_server_image }}
      test-credentials-image: ${{ inputs.test_credentials_image }}
      workflow-identifier: ${{ github.event.pull_request.number || github.run_number || 'main' }}
      java-version: ${{ needs.setup-config.outputs.java-version }}
      android-api-version: ${{ needs.setup-config.outputs.android-api-version }}
      # Use actual published client library information from main orchestrator (via setup-config)
      android-package-name: ${{ needs.setup-config.outputs.android-package-name }}
      client-version: ${{ needs.setup-config.outputs.client-version }}
      should-run-client-publishing-workflow: ${{ inputs.should-run-client-publishing-workflow }}
      cache-key: ${{ needs.analyze-e2e-requirements.outputs.cache-key-android }}

  # Job 6: OWASP ZAP DAST Security Scan - Parallel with E2E tests
  call-dast-scan:
    runs-on: ubuntu-latest
    needs: [ setup-config, validate-images, analyze-e2e-requirements ]
    if: |
      needs.validate-images.outputs.webauthn-server-ready == 'true' &&
      needs.validate-images.outputs.test-credentials-ready == 'true' &&
      needs.analyze-e2e-requirements.outputs.run-dast-scan == 'true'
    outputs:
      tests-passed: ${{ steps.zap-results.outputs.tests-passed }}
      artifact-name: "dast-scan-results-${{ github.event.pull_request.number || github.run_number || 'main' }}"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ needs.setup-config.outputs.docker-registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup secure environment and start services with Docker Compose
        working-directory: webauthn-server
        run: |
          echo "ðŸ” Setting up secure environment for DAST scanning..."

          # Use existing secure environment setup script
          chmod +x setup-secure-env.sh
          ./setup-secure-env.sh

          # Override Docker images to use the built ones for this PR/workflow
          cat >> .env << EOF

          # Override with built Docker images for DAST scanning
          WEBAUTHN_SERVER_IMAGE=${{ env.WEBAUTHN_SERVER_IMAGE }}
          TEST_CREDENTIALS_IMAGE=${{ env.TEST_CREDENTIALS_IMAGE }}
          EOF

          # Create docker compose override for DAST scanning
          cat > docker-compose.dast-override.yml << 'EOF'
          services:
            webauthn-server:
              image: ${WEBAUTHN_SERVER_IMAGE}
              # Remove build directive to use pre-built image
              build: null

            webauthn-test-credentials-service:
              image: ${TEST_CREDENTIALS_IMAGE}
              # Remove build directive to use pre-built image
              build: null
          EOF

          echo "ðŸš€ Starting services with secure Docker Compose setup..."

          # Start services using existing docker compose with override
          docker compose -f docker-compose.yml -f docker-compose.dast-override.yml up -d

          # Wait for services to be ready using existing health checks
          echo "â³ Waiting for services to be ready..."
          for i in {1..60}; do
            if docker compose -f docker-compose.yml -f docker-compose.dast-override.yml ps | grep -q "(healthy)" ; then
              echo "âœ… Services are healthy and ready for DAST scanning"
              break
            fi
            echo "Waiting for health checks... ($i/60)"
            sleep 3
          done

          # Verify services are accessible
          timeout 120 bash -c '
            while ! curl -s http://localhost:8080/health > /dev/null 2>&1; do
              echo "â³ Waiting for WebAuthn server..."
              sleep 2
            done
          '

          timeout 120 bash -c '
            while ! curl -s http://localhost:8081/health > /dev/null 2>&1; do
              echo "â³ Waiting for Test Credentials service..."
              sleep 2
            done
          '
          echo "âœ… All services ready for DAST scanning"

      - name: Run OWASP ZAP Full Scan - WebAuthn Server
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

      - name: Run OWASP ZAP Baseline Scan - Test Service
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:8081'
          rules_file_name: '.zap/rules.tsv'
        continue-on-error: true

      - name: Process DAST scan results
        id: zap-results
        if: always()
        run: |
          echo "ðŸ” OWASP ZAP DAST scans completed"
          echo "tests-passed=true" >> $GITHUB_OUTPUT

          # Save DAST results for caching
          mkdir -p dast-scan-cache
          cat > dast-scan-results.json << EOF
          {
            "status": "completed",
            "scans_performed": [
              {
                "target": "http://localhost:8080",
                "type": "full_scan",
                "timestamp": "$(date -Iseconds)"
              },
              {
                "target": "http://localhost:8081",
                "type": "baseline_scan",
                "timestamp": "$(date -Iseconds)"
              }
            ],
            "results_location": "GitHub Security tab",
            "cache_key": "${{ needs.analyze-e2e-requirements.outputs.cache-key-dast }}"
          }
          EOF

          cp dast-scan-results.json dast-scan-cache/

          echo ""
          echo "ðŸ“Š Applications Tested:"
          echo "- ðŸ” WebAuthn Server (http://localhost:8080) - Full scan"
          echo "- ðŸ§ª Test Credentials Service (http://localhost:8081) - Baseline scan"
          echo ""
          echo "ðŸ“‹ ZAP Actions Behavior:"
          echo "- Automatically create GitHub issues for HIGH/MEDIUM findings"
          echo "- Upload results to GitHub Security tab via SARIF"
          echo ""
          echo "âœ… Check GitHub Issues and Security tabs for results"

      - name: Cache DAST scan results
        if: always()
        uses: actions/cache@v4
        with:
          key: ${{ needs.analyze-e2e-requirements.outputs.cache-key-dast }}
          path: |
            dast-scan-cache/
            dast-scan-results.json

      - name: Cleanup Docker services
        if: always()
        working-directory: webauthn-server
        run: |
          echo "ðŸ§¹ Cleaning up Docker Compose services..."
          docker compose -f docker-compose.yml -f docker-compose.dast-override.yml down -v || true

          # Clean up override file
          rm -f docker-compose.dast-override.yml || true

  # Job 7: Handle cached Web E2E results with enhanced component awareness
  web-e2e-cached:
    runs-on: ubuntu-latest
    needs: [ analyze-e2e-requirements ]
    if: needs.analyze-e2e-requirements.outputs.use-web-cache == 'true'
    outputs:
      tests-passed: "true"
      artifact-name: "web-e2e-cached-results"
    steps:
      - name: Restore cached Web E2E results
        uses: actions/cache@v4
        with:
          key: ${{ needs.analyze-e2e-requirements.outputs.cache-key-web }}
          path: |
            web-e2e-cache/
            web-e2e-results.json
          fail-on-cache-miss: true

      - name: Report cached results
        run: |
          echo "âœ… Web E2E tests skipped - using cached results"
          echo "Cache key: ${{ needs.analyze-e2e-requirements.outputs.cache-key-web }}"
          echo "Previous test run was successful for identical conditions"
          if [ -f web-e2e-results.json ]; then
            echo "ðŸ“Š Cached test results available"
            cat web-e2e-results.json || echo "{\"status\": \"cached\", \"tests_passed\": true}"
          fi

  # Job 7: Handle cached Android E2E results with enhanced component awareness
  android-e2e-cached:
    runs-on: ubuntu-latest
    needs: [ analyze-e2e-requirements ]
    if: needs.analyze-e2e-requirements.outputs.use-android-cache == 'true'
    outputs:
      tests-passed: "true"
      artifact-name: "android-e2e-cached-results"
    steps:
      - name: Restore cached Android E2E results
        uses: actions/cache@v4
        with:
          key: ${{ needs.analyze-e2e-requirements.outputs.cache-key-android }}
          path: |
            android-e2e-cache/
            android-e2e-results.json
          fail-on-cache-miss: true

      - name: Report cached results
        run: |
          echo "âœ… Android E2E tests skipped - using cached results"
          echo "Cache key: ${{ needs.analyze-e2e-requirements.outputs.cache-key-android }}"
          echo "Previous test run was successful for identical conditions"
          if [ -f android-e2e-results.json ]; then
            echo "ðŸ“Š Cached test results available"
            cat android-e2e-results.json || echo "{\"status\": \"cached\", \"tests_passed\": true}"
          fi

  # Job 8: Handle cached DAST scan results
  dast-scan-cached:
    runs-on: ubuntu-latest
    needs: [ analyze-e2e-requirements ]
    if: needs.analyze-e2e-requirements.outputs.use-dast-cache == 'true'
    outputs:
      tests-passed: "true"
      artifact-name: "dast-scan-cached-results"
    steps:
      - name: Restore cached DAST scan results
        uses: actions/cache@v4
        with:
          key: ${{ needs.analyze-e2e-requirements.outputs.cache-key-dast }}
          path: |
            dast-scan-cache/
            dast-scan-results.json
          fail-on-cache-miss: true

      - name: Report cached results
        run: |
          echo "âœ… DAST scan skipped - using cached results"
          echo "Cache key: ${{ needs.analyze-e2e-requirements.outputs.cache-key-dast }}"
          echo "Previous DAST scan was successful for identical conditions"
          if [ -f dast-scan-results.json ]; then
            echo "ðŸ“Š Cached DAST results available"
            cat dast-scan-results.json || echo "{\"status\": \"cached\", \"tests_passed\": true}"
          fi

  # Job 9: Cross-platform coordination analysis
  analyze-cross-platform-results:
    runs-on: ubuntu-latest
    needs: [ analyze-e2e-requirements, call-web-e2e-tests, call-android-e2e-tests, call-dast-scan, web-e2e-cached, android-e2e-cached, dast-scan-cached ]
    if: always()
    outputs:
      overall-success: ${{ steps.analyze.outputs.overall-success }}
      parallel-execution: ${{ steps.analyze.outputs.parallel-execution }}
      performance-summary: ${{ steps.analyze.outputs.performance-summary }}
    steps:
      - name: Analyze cross-platform E2E test coordination
        id: analyze
        run: |
          echo "ðŸ“Š Analyzing cross-platform E2E test coordination results..."
          echo "ðŸ“‹ Execution Analysis:"
          echo ""

          # Determine if tests ran in parallel
          WEB_EXECUTED="false"
          ANDROID_EXECUTED="false"
          DAST_EXECUTED="false"
          PARALLEL_EXECUTION="false"

          if [[ "${{ needs.call-web-e2e-tests.result }}" == "success" ]] || [[ "${{ needs.web-e2e-cached.result }}" == "success" ]]; then
            WEB_EXECUTED="true"
          fi

          if [[ "${{ needs.call-android-e2e-tests.result }}" == "success" ]] || [[ "${{ needs.android-e2e-cached.result }}" == "success" ]]; then
            ANDROID_EXECUTED="true"
          fi

          if [[ "${{ needs.call-dast-scan.result }}" == "success" ]] || [[ "${{ needs.dast-scan-cached.result }}" == "success" ]]; then
            DAST_EXECUTED="true"
          fi

          # Check for parallel execution (any two or more jobs executed)
          EXECUTED_COUNT=0
          [[ "$WEB_EXECUTED" == "true" ]] && ((EXECUTED_COUNT++))
          [[ "$ANDROID_EXECUTED" == "true" ]] && ((EXECUTED_COUNT++))
          [[ "$DAST_EXECUTED" == "true" ]] && ((EXECUTED_COUNT++))

          if [[ $EXECUTED_COUNT -gt 1 ]]; then
            PARALLEL_EXECUTION="true"
            echo "âš™ï¸ Parallel execution achieved across multiple test types"
          elif [[ $EXECUTED_COUNT -eq 1 ]]; then
            echo "ðŸŽ¯ Single test type execution (optimized)"
          else
            echo "âš ï¸ No tests or scans executed"
          fi

          # Overall success determination
          OVERALL_SUCCESS="true"
          if [[ "${{ needs.call-web-e2e-tests.result }}" == "failure" ]] || [[ "${{ needs.call-android-e2e-tests.result }}" == "failure" ]] || [[ "${{ needs.call-dast-scan.result }}" == "failure" ]]; then
            OVERALL_SUCCESS="false"
          fi

          # Performance summary
          PERFORMANCE_SUMMARY="{"
          PERFORMANCE_SUMMARY="$PERFORMANCE_SUMMARY\"web_executed\": $WEB_EXECUTED,"
          PERFORMANCE_SUMMARY="$PERFORMANCE_SUMMARY\"android_executed\": $ANDROID_EXECUTED,"
          PERFORMANCE_SUMMARY="$PERFORMANCE_SUMMARY\"dast_executed\": $DAST_EXECUTED,"
          PERFORMANCE_SUMMARY="$PERFORMANCE_SUMMARY\"parallel_execution\": $PARALLEL_EXECUTION"
          PERFORMANCE_SUMMARY="$PERFORMANCE_SUMMARY}"

          echo "overall-success=$OVERALL_SUCCESS" >> $GITHUB_OUTPUT
          echo "parallel-execution=$PARALLEL_EXECUTION" >> $GITHUB_OUTPUT
          echo "performance-summary=$PERFORMANCE_SUMMARY" >> $GITHUB_OUTPUT

          echo ""
          echo "âœ… Cross-Platform Coordination Analysis:"
          echo "  Overall Success: $OVERALL_SUCCESS"
          echo "  Parallel Execution: $PARALLEL_EXECUTION"
          echo "  Web Platform: $WEB_EXECUTED"
          echo "  Android Platform: $ANDROID_EXECUTED"
          echo "  DAST Security Scan: $DAST_EXECUTED"

  # Job 9: Enhanced E2E test results reporting with component analysis
  report-results:
    runs-on: ubuntu-latest
    needs: [ validate-images, analyze-cross-platform-results, call-web-e2e-tests, call-android-e2e-tests, call-dast-scan, web-e2e-cached, android-e2e-cached, dast-scan-cached ]
    if: always() && github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enhanced PR comment with component-aware E2E results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          VALIDATION_RESULT: ${{ needs.validate-images.result }}
          WEB_E2E_RESULT: ${{ needs.call-web-e2e-tests.result }}
          ANDROID_E2E_RESULT: ${{ needs.call-android-e2e-tests.result }}
          WEB_TESTS_PASSED: ${{ needs.call-web-e2e-tests.outputs.tests-passed }}
          ANDROID_TESTS_PASSED: ${{ needs.call-android-e2e-tests.outputs.tests-passed }}
          WEB_ARTIFACT_NAME: ${{ needs.call-web-e2e-tests.outputs.artifact-name }}
          ANDROID_ARTIFACT_NAME: ${{ needs.call-android-e2e-tests.outputs.artifact-name }}
          WEBAUTHN_SERVER_IMAGE: ${{ env.WEBAUTHN_SERVER_IMAGE }}
          TEST_CREDENTIALS_IMAGE: ${{ env.TEST_CREDENTIALS_IMAGE }}
          # Enhanced component analysis data
          OVERALL_SUCCESS: ${{ needs.analyze-cross-platform-results.outputs.overall-success }}
          PARALLEL_EXECUTION: ${{ needs.analyze-cross-platform-results.outputs.parallel-execution }}
          PERFORMANCE_SUMMARY: ${{ needs.analyze-cross-platform-results.outputs.performance-summary }}
        run: |
          echo "ðŸ“¢ Creating enhanced E2E results comment with component analysis..."
          echo "ðŸ“‹ Enhanced Results Data:"
          echo "  Overall Success: $OVERALL_SUCCESS"
          echo "  Parallel Execution: $PARALLEL_EXECUTION"
          echo "  Performance Summary: $PERFORMANCE_SUMMARY"

          chmod +x scripts/ci/create-e2e-results-comment.cjs
          node scripts/ci/create-e2e-results-comment.cjs
