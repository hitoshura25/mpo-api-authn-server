# Smart PR Testing Workflow with Conditional Execution and Callable Workflow Architecture
#
# This workflow implements intelligent change detection and conditional execution
# to optimize CI/CD performance for pull requests. It uses callable workflows
# for better maintainability and reusability.
#
# WORKFLOW DECISION MATRIX:
# | Change Type        | Unit Tests | Docker Build | E2E Tests |
# |--------------------|-----------:|-------------:|----------:|
# | Documentation only |    âŒ Skip |     âŒ Skip |  âŒ Skip |
# | Workflow changes   |    âŒ Skip |     âŒ Skip |  âŒ Skip |
# | Source code        |     âœ… Run |      âœ… Build |   âœ… Run |
# | Tests only         |     âœ… Run |     âŒ Skip |  âŒ Skip |
# | Dockerfile only    |    âŒ Skip |      âœ… Build |   âœ… Run |
# | Build config       |     âœ… Run |      âœ… Build |   âœ… Run |
#
# PERFORMANCE BENEFITS:
# - Fast path: Documentation/workflow changes complete in ~30 seconds
# - Standard path: Full CI pipeline takes ~8 minutes when needed
# - Smart detection: Only run tests/builds for relevant changes
# - Callable workflows: Reduced complexity and improved maintainability
#
# ARCHITECTURE:
# - detect-changes: Smart change detection and execution strategy
# - unit-tests.yml: Callable workflow for unit testing and coverage
# - docker-build.yml: Callable workflow for Docker build/scan/push
# - report-build-results: Results aggregation and status reporting

name: Build and Test - Orchestration Workflow

on:
  workflow_call:
    outputs:
      docker_images_built:
        description: 'Whether Docker images were built and pushed'
        value: ${{ jobs.docker-build-scan-push.outputs.images-pushed }}
      webauthn_server_image:
        description: 'WebAuthn server Docker image tag'
        value: ${{ jobs.docker-build-scan-push.outputs.webauthn-server-image }}
      test_credentials_image:
        description: 'Test credentials service Docker image tag'
        value: ${{ jobs.docker-build-scan-push.outputs.test-credentials-image }}
      security_scan_passed:
        description: 'Whether Docker security scan passed'
        value: ${{ jobs.docker-build-scan-push.outputs.security-scan-passed }}
      critical_vulnerabilities:
        description: 'Number of critical vulnerabilities found'
        value: ${{ jobs.docker-build-scan-push.outputs.critical-vulnerabilities }}
      unit_tests_passed:
        description: 'Whether unit tests passed successfully'
        value: ${{ jobs.run-unit-tests.outputs.tests-passed }}
      coverage_uploaded:
        description: 'Whether coverage reports were uploaded'
        value: ${{ jobs.run-unit-tests.outputs.coverage-uploaded }}

env:
  ANDROID_API_VERSION: "29"
  JAVA_VERSION: "21"
  DOCKER_REGISTRY: ghcr.io
  DOCKER_IMAGE_NAME: hitoshura25/webauthn-server
  DOCKER_TEST_CREDENTIALS_IMAGE_NAME: hitoshura25/webauthn-test-credentials-service

jobs:
  # Job 1: Detect what changed to determine execution strategy
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # Core decision outputs - used by other jobs/steps in this workflow
      should-build-docker: ${{ steps.decision-matrix.outputs.should-build-docker }}        # Used by: build-docker-images job condition & reporting
      should-run-tests: ${{ steps.decision-matrix.outputs.should-run-tests }}              # Used by: run-unit-tests job condition & reporting
      fast-path-eligible: ${{ steps.decision-matrix.outputs.fast-path-eligible }}          # Used by: reporting steps for status display
      source-code-changes: ${{ steps.decision-matrix.outputs.source-code-changes }}        # Used by: reporting step to show change type
      dockerfile-only-changes: ${{ steps.decision-matrix.outputs.dockerfile-only-changes }} # Used by: reporting step to show change type
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docs-changed:
              - '**.md'
              - 'docs/**'
              - '!.github/workflows/**'
            workflows-changed:
              - '.github/workflows/**'
            webauthn-server-tests:
              - 'webauthn-server/src/**'
              - 'webauthn-server/build.gradle.kts'
              - 'webauthn-test-lib/**'
              - 'settings.gradle.kts'
              - 'build.gradle.kts'
              - 'gradle.properties'
              - 'gradle/**'
            webauthn-server-docker:
              - 'webauthn-server/src/main/**'
              - 'webauthn-server/Dockerfile'
              - 'webauthn-server/build.gradle.kts'
              - 'webauthn-test-lib/src/main/**'
              - 'settings.gradle.kts'
              - 'build.gradle.kts'
              - 'gradle.properties'
            test-credentials-tests:
              - 'webauthn-test-credentials-service/src/**'
              - 'webauthn-test-credentials-service/build.gradle.kts'
              - 'webauthn-test-lib/**'
              - 'settings.gradle.kts'
              - 'build.gradle.kts'
              - 'gradle.properties'
              - 'gradle/**'
            test-credentials-docker:
              - 'webauthn-test-credentials-service/src/main/**'
              - 'webauthn-test-credentials-service/Dockerfile'
              - 'webauthn-test-credentials-service/build.gradle.kts'
              - 'webauthn-test-lib/src/main/**'
              - 'settings.gradle.kts'
              - 'build.gradle.kts'
              - 'gradle.properties'

      - name: Print raw change detection results
        run: |
          echo "ğŸ” Raw Change Detection Results:"
          echo "docs-changed: ${{ steps.changes.outputs.docs-changed }}"
          echo "workflows-changed: ${{ steps.changes.outputs.workflows-changed }}"
          echo "webauthn-server-tests: ${{ steps.changes.outputs.webauthn-server-tests }}"
          echo "webauthn-server-docker: ${{ steps.changes.outputs.webauthn-server-docker }}"
          echo "test-credentials-tests: ${{ steps.changes.outputs.test-credentials-tests }}"
          echo "test-credentials-docker: ${{ steps.changes.outputs.test-credentials-docker }}"

      - name: Apply decision matrix logic
        id: decision-matrix
        run: |
          # Store raw filter results in variables
          DOCS_CHANGED="${{ steps.changes.outputs.docs-changed }}"
          WORKFLOWS_CHANGED="${{ steps.changes.outputs.workflows-changed }}"
          WEBAUTHN_TESTS="${{ steps.changes.outputs.webauthn-server-tests }}"
          WEBAUTHN_DOCKER="${{ steps.changes.outputs.webauthn-server-docker }}"
          TEST_CREDS_TESTS="${{ steps.changes.outputs.test-credentials-tests }}"
          TEST_CREDS_DOCKER="${{ steps.changes.outputs.test-credentials-docker }}"

          echo "ğŸ§® Applying Decision Matrix Logic..."
          echo ""
          echo "ğŸ“‹ Reference Decision Matrix:"
          echo "| Change Type        | Unit Tests | Docker Build | E2E Tests |"
          echo "|--------------------|-----------|-------------|-----------|"
          echo "| Documentation only |    âŒ Skip |     âŒ Skip |  âŒ Skip |"
          echo "| Workflow changes   |    âŒ Skip |     âŒ Skip |  âŒ Skip |"
          echo "| Source code        |     âœ… Run |      âœ… Build |   âœ… Run |"
          echo "| Tests only         |     âœ… Run |     âŒ Skip |  âŒ Skip |"
          echo "| Dockerfile only    |    âŒ Skip |      âœ… Build |   âœ… Run |"
          echo "| Build config       |     âœ… Run |      âœ… Build |   âœ… Run |"
          echo ""
          echo "ğŸ” Analyzing current changes (using PRIORITY ORDER):"
          echo "  1ï¸âƒ£ Source code changes (highest priority): $([ "$WEBAUTHN_TESTS" = "true" ] || [ "$TEST_CREDS_TESTS" = "true" ] && echo "YES" || echo "no")"
          echo "  2ï¸âƒ£ Dockerfile-only changes: $([ "$WEBAUTHN_DOCKER" = "true" ] || [ "$TEST_CREDS_DOCKER" = "true" ] && echo "YES" || echo "no") (only if no source code changes)"
          echo "  3ï¸âƒ£ Documentation-only changes: $([ "$DOCS_CHANGED" = "true" ] && [ "$WORKFLOWS_CHANGED" = "false" ] && echo "YES" || echo "no") (only if no code/docker changes)"
          echo "  4ï¸âƒ£ Workflow-only changes: $([ "$WORKFLOWS_CHANGED" = "true" ] && [ "$DOCS_CHANGED" = "false" ] && echo "YES" || echo "no") (only if no code/docker changes)"
          echo ""

          # Calculate decision matrix categories based on PRIORITY ORDER
          # Higher priority conditions override lower priority ones

          # Priority 1: Source code changes (any test changes) - highest priority
          if [[ "$WEBAUTHN_TESTS" == "true" ]] || [[ "$TEST_CREDS_TESTS" == "true" ]]; then
            echo "source-code-changes=true" >> $GITHUB_OUTPUT
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
            echo "should-build-docker=true" >> $GITHUB_OUTPUT
            echo "tests-only-changes=false" >> $GITHUB_OUTPUT
            echo "dockerfile-only-changes=false" >> $GITHUB_OUTPUT
            echo "build-config-changes=false" >> $GITHUB_OUTPUT
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "workflows-only=false" >> $GITHUB_OUTPUT
            echo "fast-path-eligible=false" >> $GITHUB_OUTPUT
            DECISION="Source code changes detected"
          # Priority 2: Dockerfile only (docker changes but no test changes)
          elif [[ "$WEBAUTHN_DOCKER" == "true" ]] || [[ "$TEST_CREDS_DOCKER" == "true" ]]; then
            echo "source-code-changes=false" >> $GITHUB_OUTPUT
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
            echo "should-build-docker=true" >> $GITHUB_OUTPUT
            echo "tests-only-changes=false" >> $GITHUB_OUTPUT
            echo "dockerfile-only-changes=true" >> $GITHUB_OUTPUT
            echo "build-config-changes=false" >> $GITHUB_OUTPUT
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "workflows-only=false" >> $GITHUB_OUTPUT
            echo "fast-path-eligible=false" >> $GITHUB_OUTPUT
            DECISION="Dockerfile-only changes detected"
          # Priority 3: Documentation only (docs changed but nothing else)
          elif [[ "$DOCS_CHANGED" == "true" ]] && [[ "$WORKFLOWS_CHANGED" == "false" ]]; then
            echo "source-code-changes=false" >> $GITHUB_OUTPUT
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
            echo "should-build-docker=false" >> $GITHUB_OUTPUT
            echo "tests-only-changes=false" >> $GITHUB_OUTPUT
            echo "dockerfile-only-changes=false" >> $GITHUB_OUTPUT
            echo "build-config-changes=false" >> $GITHUB_OUTPUT
            echo "docs-only=true" >> $GITHUB_OUTPUT
            echo "workflows-only=false" >> $GITHUB_OUTPUT
            echo "fast-path-eligible=true" >> $GITHUB_OUTPUT
            DECISION="Documentation-only changes detected"
          # Priority 4: Workflow only (workflows changed but nothing else)
          elif [[ "$WORKFLOWS_CHANGED" == "true" ]] && [[ "$DOCS_CHANGED" == "false" ]]; then
            echo "source-code-changes=false" >> $GITHUB_OUTPUT
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
            echo "should-build-docker=false" >> $GITHUB_OUTPUT
            echo "tests-only-changes=false" >> $GITHUB_OUTPUT
            echo "dockerfile-only-changes=false" >> $GITHUB_OUTPUT
            echo "build-config-changes=false" >> $GITHUB_OUTPUT
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "workflows-only=true" >> $GITHUB_OUTPUT
            echo "fast-path-eligible=true" >> $GITHUB_OUTPUT
            DECISION="Workflow-only changes detected"
          # Priority 5: Mixed docs + workflow changes (fast path)
          elif [[ "$DOCS_CHANGED" == "true" ]] && [[ "$WORKFLOWS_CHANGED" == "true" ]]; then
            echo "source-code-changes=false" >> $GITHUB_OUTPUT
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
            echo "should-build-docker=false" >> $GITHUB_OUTPUT
            echo "tests-only-changes=false" >> $GITHUB_OUTPUT
            echo "dockerfile-only-changes=false" >> $GITHUB_OUTPUT
            echo "build-config-changes=false" >> $GITHUB_OUTPUT
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "workflows-only=false" >> $GITHUB_OUTPUT
            echo "fast-path-eligible=true" >> $GITHUB_OUTPUT
            DECISION="Documentation + workflow changes (no code changes)"
          # Default: No significant changes
          else
            echo "source-code-changes=false" >> $GITHUB_OUTPUT
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
            echo "should-build-docker=false" >> $GITHUB_OUTPUT
            echo "tests-only-changes=false" >> $GITHUB_OUTPUT
            echo "dockerfile-only-changes=false" >> $GITHUB_OUTPUT
            echo "build-config-changes=false" >> $GITHUB_OUTPUT
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "workflows-only=false" >> $GITHUB_OUTPUT
            echo "fast-path-eligible=true" >> $GITHUB_OUTPUT
            DECISION="No significant changes detected"
          fi

          echo "ğŸ¯ Decision: $DECISION"

      - name: Print execution strategy
        run: |
          echo "ğŸš€ Execution Strategy Based on Decision Matrix:"
          echo "ğŸ“Š Calculated Decisions:"
          echo "  â€¢ Source code changes: ${{ steps.decision-matrix.outputs.source-code-changes }}"
          echo "  â€¢ Tests-only changes: ${{ steps.decision-matrix.outputs.tests-only-changes }}"
          echo "  â€¢ Dockerfile-only changes: ${{ steps.decision-matrix.outputs.dockerfile-only-changes }}"
          echo "  â€¢ Documentation-only: ${{ steps.decision-matrix.outputs.docs-only }}"
          echo "  â€¢ Workflow-only: ${{ steps.decision-matrix.outputs.workflows-only }}"
          echo "  â€¢ Fast path eligible: ${{ steps.decision-matrix.outputs.fast-path-eligible }}"
          echo ""
          echo "âš™ï¸  Pipeline Actions:"
          echo "  â€¢ Should run unit tests: ${{ steps.decision-matrix.outputs.should-run-tests }}"
          echo "  â€¢ Should build Docker images: ${{ steps.decision-matrix.outputs.should-build-docker }}"
          echo ""

          if [[ "${{ steps.decision-matrix.outputs.source-code-changes }}" == "true" ]]; then
            echo "âœ… Source code changes - Will run unit tests AND build Docker images for E2E tests"
            echo "    ğŸ§ª Unit Tests: ENABLED (source code changed)"
            echo "    ğŸ³ Docker Build: ENABLED (for E2E testing)"
            echo "    ğŸ¯ E2E Tests: ENABLED (using built images)"
          elif [[ "${{ steps.decision-matrix.outputs.dockerfile-only-changes }}" == "true" ]]; then
            echo "âœ… Dockerfile-only changes - Will build Docker images for E2E tests (skip unit tests)"
            echo "    ğŸ§ª Unit Tests: SKIPPED (no test code changes)"
            echo "    ğŸ³ Docker Build: ENABLED (Dockerfile changed)"
            echo "    ğŸ¯ E2E Tests: ENABLED (using built images)"
          elif [[ "${{ steps.decision-matrix.outputs.docs-only }}" == "true" ]]; then
            echo "âš¡ Documentation-only changes - Fast path (no tests/builds needed)"
            echo "    ğŸ§ª Unit Tests: SKIPPED (no code changes)"
            echo "    ğŸ³ Docker Build: SKIPPED (no code/Docker changes)"
            echo "    ğŸ¯ E2E Tests: SKIPPED (no images to test)"
          elif [[ "${{ steps.decision-matrix.outputs.workflows-only }}" == "true" ]]; then
            echo "âš¡ Workflow-only changes - Fast path (no tests/builds needed)"
            echo "    ğŸ§ª Unit Tests: SKIPPED (no code changes)"
            echo "    ğŸ³ Docker Build: SKIPPED (no code/Docker changes)"
            echo "    ğŸ¯ E2E Tests: SKIPPED (no images to test)"
          elif [[ "${{ steps.decision-matrix.outputs.fast-path-eligible }}" == "true" ]]; then
            echo "âš¡ Fast path - No significant code changes detected"
            echo "    ğŸ§ª Unit Tests: SKIPPED (no significant changes)"
            echo "    ğŸ³ Docker Build: SKIPPED (no significant changes)"
            echo "    ğŸ¯ E2E Tests: SKIPPED (no significant changes)"
          else
            echo "ğŸ¤” Unexpected state - Please check decision matrix logic"
            echo "    This should not happen - all cases should be covered"
          fi

  # Job 2: Run unit tests using callable workflow
  run-unit-tests:
    uses: ./.github/workflows/unit-tests.yml
    needs: detect-changes
    if: needs.detect-changes.outputs.should-run-tests == 'true'
    with:
      changes-detected: ${{ needs.detect-changes.outputs.should-run-tests == 'true' }}
      test-scope: 'all'
      java-version: ${{ env.JAVA_VERSION }}
    secrets: inherit

  # Job 3: Docker build, scan, and push using callable workflow
  docker-build-scan-push:
    uses: ./.github/workflows/docker-build.yml
    needs: [ detect-changes, run-unit-tests ]
    if: |
      always() &&
      needs.detect-changes.outputs.should-build-docker == 'true' &&
      (needs.run-unit-tests.result == 'success' ||
       needs.run-unit-tests.result == 'skipped' ||
       needs.detect-changes.outputs.should-run-tests == 'false')
    with:
      docker-changes-detected: ${{ needs.detect-changes.outputs.should-build-docker == 'true' }}
      java-version: ${{ env.JAVA_VERSION }}
      push-enabled: true
      registry-url: ${{ env.DOCKER_REGISTRY }}
      webauthn-image-name: ${{ env.DOCKER_IMAGE_NAME }}
      test-credentials-image-name: ${{ env.DOCKER_TEST_CREDENTIALS_IMAGE_NAME }}
    secrets: inherit

  # Job 4: Report build results (E2E triggering now handled by orchestrator)
  report-build-results:
    runs-on: ubuntu-latest
    needs: [ detect-changes, run-unit-tests, docker-build-scan-push ]
    if: always()
    steps:
      - name: Report build status
        run: |
          echo "ğŸ“Š Build and Test Results Summary:"
          echo "Fast path eligible: ${{ needs.detect-changes.outputs.fast-path-eligible }}"
          echo "Should run tests: ${{ needs.detect-changes.outputs.should-run-tests }}"
          echo "Should build Docker: ${{ needs.detect-changes.outputs.should-build-docker }}"
          echo "Source code changes: ${{ needs.detect-changes.outputs.source-code-changes }}"
          echo "Dockerfile-only changes: ${{ needs.detect-changes.outputs.dockerfile-only-changes }}"
          echo "Unit tests: ${{ needs.run-unit-tests.result }}"
          echo "Unit tests passed: ${{ needs.run-unit-tests.outputs.tests-passed }}"
          echo "Coverage uploaded: ${{ needs.run-unit-tests.outputs.coverage-uploaded }}"
          echo "Docker images built: ${{ needs.docker-build-scan-push.outputs.images-built }}"
          echo "Docker images pushed: ${{ needs.docker-build-scan-push.outputs.images-pushed }}"
          echo "Security scan passed: ${{ needs.docker-build-scan-push.outputs.security-scan-passed }}"
          echo "Critical vulnerabilities: ${{ needs.docker-build-scan-push.outputs.critical-vulnerabilities }}"

          if [[ "${{ needs.docker-build-scan-push.outputs.images-pushed }}" == "true" ]]; then
            echo "âœ… Docker images successfully built, scanned, and pushed:"
            echo "  WebAuthn Server: ${{ needs.docker-build-scan-push.outputs.webauthn-server-image }}"
            echo "  Test Credentials: ${{ needs.docker-build-scan-push.outputs.test-credentials-image }}"
            echo "ğŸ”’ Security scan passed with ${{ needs.docker-build-scan-push.outputs.critical-vulnerabilities }} critical vulnerabilities"
            echo "ğŸš€ Ready for E2E tests"
          elif [[ "${{ needs.docker-build-scan-push.outputs.security-scan-passed }}" == "false" ]]; then
            echo "ğŸš¨ SECURITY SCAN FAILED - Docker images built but NOT pushed"
            echo "Critical vulnerabilities found: ${{ needs.docker-build-scan-push.outputs.critical-vulnerabilities }}"
            echo "âŒ Images blocked from registry due to security issues"
          elif [[ "${{ needs.docker-build-scan-push.outputs.images-built }}" == "true" ]]; then
            echo "ğŸ”§ Docker images built successfully but push was skipped or failed"
            echo "Security scan status: ${{ needs.docker-build-scan-push.outputs.security-scan-passed }}"
          elif [[ "${{ needs.detect-changes.outputs.fast-path-eligible }}" == "true" ]]; then
            echo "âš¡ Fast path completed - no builds needed (docs/workflow changes only)"
          elif [[ "${{ needs.run-unit-tests.outputs.tests-passed }}" == "true" ]]; then
            echo "ğŸ”§ Unit tests passed, Docker build skipped (test-only changes)"
          else
            echo "ğŸ“‹ Build phase analysis completed"
          fi
