name: Run Client E2E Tests (Web + Android)

# Optimized for PR speed validation - targets ~8-12 minute total runtime
# Future optimization: Pre-built Docker images in GHCR for faster service startup

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '18'
    secrets:
      codecov_token:
        description: 'Codecov token for uploading coverage reports'
        required: true
      gradle_encryption_key:
        description: 'Gradle encryption key'
        required: true
      docker_hub_username:
        description: 'DockerHub username'
        required: true
      docker_hub_token:
        description: 'DockerHub token'
        required: true
    outputs:
      web-test-exit-code:
        description: 'Exit code from web tests'
        value: ${{ jobs.web-e2e-tests.outputs.test-exit-code }}
      android-test-exit-code:
        description: 'Exit code from Android tests'
        value: ${{ jobs.android-e2e-tests.outputs.test-exit-code }}

jobs:
  web-e2e-tests:
    runs-on: ubuntu-latest
    outputs:
      test-exit-code: ${{ steps.run-tests.outputs.test-exit-code }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Branch-specific Gradle caching
      - name: Setup branch-specific Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle/configuration-cache
          key: gradle-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-${{ github.ref_name }}-
            gradle-${{ runner.os }}-main-
            gradle-${{ runner.os }}-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.gradle_encryption_key }}
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"
          # Disable built-in cache since we're managing it manually
          cache-disabled: true

      - name: Run code quality checks, tests, coverage, and build JARs
        shell: bash
        run: ./gradlew detekt :webauthn-server:koverXmlReport :webauthn-server:shadowJar :webauthn-test-credentials-service:shadowJar --build-cache --parallel --configuration-cache

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: webauthn-server-reports
          path: |
            webauthn-server/build/reports/
          retention-days: 7

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./webauthn-server/build/reports/kover/report.xml
          flags: unit
          name: codecov-unit
          token: ${{ secrets.codecov_token }}
          fail_ci_if_error: true

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: hitoshura25/webauthn-server
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=pr

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: test-client/package-lock.json

      - name: Install test dependencies (parallel)
        working-directory: test-client
        run: |
          # Install npm dependencies and Playwright in parallel
          npm ci &
          NPM_PID=$!
          
          # Download Playwright browser in background
          npx playwright install chromium --only-shell &
          PLAYWRIGHT_PID=$!
          
          # Wait for both to complete
          wait $NPM_PID
          wait $PLAYWRIGHT_PID
          
          echo "✅ Dependencies installed in parallel"

      - name: Set up environment and start services
        run: |
          cd webauthn-server
          ./setup-secure-env.sh

          echo "🔨 Building services..."
          DOCKER_BUILDKIT=1 COMPOSE_DOCKER_CLI_BUILD=1 docker compose up -d --build

          echo "⏳ Waiting for services to start..."
          sleep 10

          echo "📊 Service status after initial startup:"
          docker compose ps

          echo "📋 Full logs from all services:"
          docker compose logs

          echo "🔍 Testing dependency services first..."

          # Check if postgres is responding
          if docker compose exec postgres pg_isready -U webauthn_user -d webauthn_db > /dev/null 2>&1; then
            echo "✅ PostgreSQL is ready"
          else
            echo "❌ PostgreSQL not ready"
            echo "PostgreSQL logs:"
            docker compose logs postgres
          fi

          # Check if redis is responding
          if docker compose exec redis redis-cli ping > /dev/null 2>&1; then
            echo "✅ Redis is ready"
          else
            echo "❌ Redis not ready"
            echo "Redis logs:"
            docker compose logs redis
          fi

          # Check if jaeger is responding
          if curl -f --max-time 5 http://localhost:16686/ > /dev/null 2>&1; then
            echo "✅ Jaeger is ready"
          else
            echo "❌ Jaeger not ready"
            echo "Jaeger logs:"
            docker compose logs jaeger
          fi

          echo "🔍 Testing main application services..."

          # Test webauthn-server health endpoint
          if curl -f --max-time 5 http://localhost:8080/health > /dev/null 2>&1; then
            echo "✅ WebAuthn server health check passed"
          else
            echo "❌ WebAuthn server health check failed"
            echo "WebAuthn server logs:"
            docker compose logs webauthn-server
            exit 1
          fi

          # Test webauthn-test-credentials-service health
          if curl -f --max-time 5 http://localhost:8081/health > /dev/null 2>&1; then
            echo "✅ WebAuthn test credentials service responding"
          else
            echo "❌ WebAuthn test credentials service not responding"
            echo "Service logs:"
            docker compose logs webauthn-test-credentials-service
            exit 1
          fi
          cd ..

      - name: Run E2E tests
        id: run-tests
        working-directory: test-client
        run: |
          set +e
          npm test
          TEST_EXIT_CODE=$?
          set -e

          # Store exit code for later use
          echo "test-exit-code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "❌ Tests failed with exit code $TEST_EXIT_CODE"
            exit $TEST_EXIT_CODE
          else
            echo "✅ Tests passed successfully"
          fi


      - name: Stop full stack
        id: stop-full-stack
        if: always()
        run: |
          echo "Capturing Docker Compose logs..."
          cd webauthn-server
          docker compose logs > ../docker-compose-logs.txt 2>&1
          echo "Stopping Docker Compose services..."
          docker compose down -v
          echo "✅ Docker Compose services stopped"

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            test-client/playwright-report/
            test-client/test-results/
            android-test-client/app/build/reports/androidTests/connected/
            android-test-client/app/build/outputs/androidTest-results/connected/
          retention-days: 3

      - name: Upload Docker Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docker-logs
          path: docker-compose-logs.txt
          retention-days: 3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ secrets.docker_hub_username }}
          password: ${{ secrets.docker_hub_token }}

      - name: Build and push
        uses: docker/build-push-action@v6
        if: github.event_name != 'pull_request'
        with:
          context: ./webauthn-server
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Update repo description
        uses: peter-evans/dockerhub-description@v4
        if: github.event_name != 'pull_request'
        with:
          username: ${{ secrets.docker_hub_username }}
          password: ${{ secrets.docker_hub_token }}
          repository: hitoshura25/webauthn-server
          short-description: ${{ github.event.repository.description }}

  android-e2e-tests:
    runs-on: ubuntu-latest
    outputs:
      test-exit-code: ${{ steps.android-tests.outputs.test-exit-code }}
      android-tests-skipped: ${{ steps.android-tests.outputs.android-tests-skipped }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle/configuration-cache
          key: gradle-android-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-android-${{ runner.os }}-${{ github.ref_name }}-
            gradle-android-${{ runner.os }}-main-
            gradle-android-${{ runner.os }}-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-disabled: true

      - name: Build and generate Android client (fast)
        run: |
          echo "🔨 Building server and generating Android client..."
          # Build only what we need for client generation
          ./gradlew :webauthn-server:compileKotlin :webauthn-server:copyGeneratedClientToLibrary --build-cache --parallel --configuration-cache
          
          # Verify client generation
          if [ -f "android-test-client/client-library/src/main/java/com/vmenon/mpo/api/authn/client/api/RegistrationApi.java" ]; then
            echo "✅ Android client generated successfully"
          else
            echo "❌ Android client generation failed"
            exit 1
          fi

      - name: Start services (lightweight)
        run: |
          echo "🚀 Starting minimal services for Android tests..."
          cd webauthn-server
          
          # Start only required services in background
          docker compose -f docker-compose.deps.yml up -d postgres redis
          
          # Build and start services
          ./gradlew :webauthn-server:shadowJar :webauthn-test-credentials-service:shadowJar --build-cache --parallel
          
          # Start servers in background
          java -jar webauthn-server/build/libs/webauthn-server-*-all.jar &
          SERVER_PID=$!
          java -jar webauthn-test-credentials-service/build/libs/webauthn-test-credentials-service-*-all.jar &
          TEST_SERVICE_PID=$!
          
          # Store PIDs for cleanup
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          echo "TEST_SERVICE_PID=$TEST_SERVICE_PID" >> $GITHUB_ENV
          
          # Wait for services
          sleep 15
          
          # Quick health checks
          curl -f http://localhost:8080/health || exit 1
          curl -f http://localhost:8081/health || exit 1
          
          echo "✅ Services ready"

      - name: Run Android tests with emulator (with timeout)
        id: android-tests
        timeout-minutes: 15
        continue-on-error: true
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 28
          target: default
          arch: x86_64
          cores: 2
          ram-size: 2048M
          heap-size: 256M
          disk-size: 2048M
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          enable-hw-keyboard: true
          emulator-options: -no-window -no-snapshot-save -no-snapshot-load -no-boot-anim -netfast -gpu swiftshader_indirect
          script: |
            set +e
            
            echo "⏱️ Starting Android tests with 15-minute timeout..."
            
            # Wait for emulator with timeout
            echo "📱 Waiting for emulator to be ready..."
            timeout 300 adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\r') ]]; do sleep 2; done'
            EMULATOR_READY=$?
            
            if [ $EMULATOR_READY -ne 0 ]; then
              echo "❌ Emulator failed to start within 5 minutes"
              exit 1
            fi
            
            # Unlock device and verify it's responsive
            adb shell input keyevent 82
            sleep 2
            
            # Quick responsiveness test
            timeout 30 adb shell getprop ro.build.version.release
            if [ $? -ne 0 ]; then
              echo "❌ Emulator not responsive"
              exit 1
            fi
            
            echo "✅ Emulator ready and responsive"
            
            # Run Android unit tests first (fast)
            cd android-test-client
            echo "🧪 Running Android unit tests..."
            timeout 300 ./gradlew test --build-cache --parallel
            UNIT_TEST_EXIT=$?
            
            if [ $UNIT_TEST_EXIT -ne 0 ]; then
              echo "❌ Unit tests failed"
              exit $UNIT_TEST_EXIT
            fi
            
            # Run instrumentation tests with timeout
            echo "🧪 Running WebAuthnFlowTest instrumentation tests..."
            timeout 600 ./gradlew connectedAndroidTest --build-cache --parallel --info
            TEST_EXIT_CODE=$?
            
            set -e
            echo "test-exit-code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
            
            if [ $TEST_EXIT_CODE -ne 0 ]; then
              echo "❌ Android instrumentation tests failed with exit code $TEST_EXIT_CODE"
              exit $TEST_EXIT_CODE
            else
              echo "✅ Android tests passed successfully"
            fi

      - name: Handle emulator test failure
        id: emulator-fallback
        if: failure() && steps.android-tests.outcome == 'failure'
        run: |
          echo "⚠️ Android emulator tests failed or timed out"
          echo "🔄 Running unit tests only as fallback..."
          
          cd android-test-client
          
          # Run unit tests without emulator
          ./gradlew test --build-cache --parallel
          UNIT_TEST_EXIT=$?
          
          if [ $UNIT_TEST_EXIT -eq 0 ]; then
            echo "✅ Android unit tests passed (emulator tests skipped)"
            echo "android-tests-skipped=true" >> $GITHUB_OUTPUT
            echo "test-exit-code=0" >> $GITHUB_OUTPUT
          else
            echo "❌ Android unit tests also failed"
            echo "android-tests-skipped=true" >> $GITHUB_OUTPUT  
            echo "test-exit-code=$UNIT_TEST_EXIT" >> $GITHUB_OUTPUT
            exit $UNIT_TEST_EXIT
          fi

      - name: Cleanup Android services
        if: always()
        run: |
          echo "🧹 Cleaning up services..."
          
          # Stop background services
          if [ ! -z "$SERVER_PID" ]; then
            kill $SERVER_PID 2>/dev/null || true
          fi
          if [ ! -z "$TEST_SERVICE_PID" ]; then
            kill $TEST_SERVICE_PID 2>/dev/null || true
          fi
          
          # Stop Docker containers
          cd webauthn-server
          docker compose -f docker-compose.deps.yml down || true
          
          echo "✅ Cleanup completed"

      - name: Upload Android test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-test-reports
          path: |
            android-test-client/app/build/reports/androidTests/connected/
            android-test-client/app/build/outputs/androidTest-results/connected/
          retention-days: 3
